<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∏–∫—Ä–æ–ü–æ–º–æ—â—å PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --surface: #FFFFFF; --text: #1C1C1E; --green: #34C759; --orange: #FF9500; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--text); -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        
        .header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        .card { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; margin-top: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn-p { background: var(--primary); color: white; }
        .btn-g { background: var(--green); color: white; }
        .btn-o { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* UI –≠–õ–ï–ú–ï–ù–¢–´ */
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; float: right; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #EEE; z-index: 999; }
        .nav-item { text-align: center; font-size: 10px; color: #8E8E93; font-weight: 600; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; }
        
        input, textarea { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #E5E5EA; background: #F9F9F9; box-sizing: border-box; font-family: inherit; }
        
        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–ï */
        #notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 20px; border-radius: 30px; z-index: 3000; display: none; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 80%; text-align: center; }

        /* –ú–û–î–ê–õ–ö–ê –û–¢–ó–´–í–ê */
        #review-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; display: none; align-items: center; justify-content: center; }
        .star { font-size: 30px; color: #DDD; cursor: pointer; transition: 0.2s; }
        .star.active { color: var(--orange); }

        /* –ö–ê–†–¢–ê */
        #map { height: 70vh; width: 100%; }
        
        /* –ß–ê–¢ */
        #chat-ui { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background: #F2F2F7; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 75%; font-size: 14px; }
        .msg.me { align-self: flex-end; background: var(--primary); color: white; }
        .msg.other { align-self: flex-start; background: white; }
    </style>
</head>
<body>

<div id="notification">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>

<div id="scr-auth" style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: white; text-align: center;">
    <h1 style="color: var(--primary); font-size: 40px; margin: 0;">MicroHelp</h1>
    <p style="color: #8E8E93;">–ü–æ–º–æ—â—å –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å</p>
    <div style="width: 100%; max-width: 300px;">
        <button class="btn btn-p" onclick="login('client')">üôã‚Äç‚ôÇÔ∏è –Ø –ó–∞–∫–∞–∑—á–∏–∫</button>
        <button class="btn" style="background:#E5E5EA; color:#333" onclick="login('worker')">üõ† –Ø –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</button>
    </div>
</div>

<div id="scr-main" style="display: none;">
    <div class="header">
        <b id="page-title">–õ–µ–Ω—Ç–∞</b>
        <div onclick="switchTab('profile')" style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <span id="header-balance" style="font-size: 14px;">0 ‚ÇΩ</span>
            <span id="header-avatar" style="font-size: 20px;">üë§</span>
        </div>
    </div>

    <div id="view-feed" class="container"></div>
    <div id="view-my-orders" class="container" style="display:none"></div>
    <div id="view-map" style="display:none"><div id="map"></div></div>
    
    <div id="view-create" class="container" style="display:none">
        <h2>–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        <div class="card">
            <input id="inp-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            <input id="inp-price" type="number" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)">
            <p style="font-size: 12px; color: #8E8E93;">–ö–æ–º–∏—Å—Å–∏—è 0% –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞</p>
            <button class="btn btn-p" onclick="createTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
        </div>
    </div>

    <div id="view-profile" class="container" style="display:none">
        <div class="card" style="text-align: center;">
            <div style="font-size: 50px; margin-bottom: 10px;" id="profile-avatar">üë§</div>
            <h2 id="profile-name" style="margin:0">–ò–º—è</h2>
            <div style="color: var(--orange); font-weight: 800; margin-top: 5px;">‚≠ê <span id="profile-rating">5.0</span></div>
            <hr style="border: 0; border-top: 1px solid #EEE; margin: 20px 0;">
            
            <input id="edit-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input id="edit-avatar" placeholder="–í–∞—à –∞–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)">
            <button class="btn btn-o" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
        <h3>–û—Ç–∑—ã–≤—ã –æ–±–æ –º–Ω–µ</h3>
        <div id="reviews-list"></div>
    </div>

    <div class="nav-bottom">
        <div class="nav-item active" onclick="switchTab('feed')" id="nav-feed"><span class="nav-icon">üè†</span>–õ–µ–Ω—Ç–∞</div>
        <div class="nav-item" onclick="switchTab('map')" id="nav-map"><span class="nav-icon">üó∫</span>–ö–∞—Ä—Ç–∞</div>
        <div class="nav-item" onclick="switchTab('create')" id="nav-create" style="display:none"><span class="nav-icon">‚ûï</span>–°–æ–∑–¥–∞—Ç—å</div>
        <div class="nav-item" onclick="switchTab('my-orders')" id="nav-my-orders" style="display:none"><span class="nav-icon">üìã</span>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
        <div class="nav-item" onclick="switchTab('profile')" id="nav-profile"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
</div>

<div id="chat-ui">
    <div class="header">
        <button onclick="closeChat()" style="border:none; background:none; font-size: 20px;">‚úï</button>
        <b id="chat-title">–ß–∞—Ç</b>
        <div style="width:20px"></div>
    </div>
    <div id="chat-box" class="chat-msgs"></div>
    <div style="padding:15px; border-top:1px solid #EEE; display:flex; gap:10px;">
        <input id="chat-inp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
        <button class="btn btn-p" style="width:auto; margin:0; padding:0 20px" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<div id="review-modal">
    <div class="card" style="width: 80%; text-align: center;">
        <h3>–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
        <p>–û—Ü–µ–Ω–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ:</p>
        <div style="margin-bottom: 15px;">
            <span class="star" onclick="setStar(1)">‚òÖ</span>
            <span class="star" onclick="setStar(2)">‚òÖ</span>
            <span class="star" onclick="setStar(3)">‚òÖ</span>
            <span class="star" onclick="setStar(4)">‚òÖ</span>
            <span class="star" onclick="setStar(5)">‚òÖ</span>
        </div>
        <textarea id="review-text" rows="3" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
        <button class="btn btn-p" onclick="submitReview()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
    </div>
</div>

<script>
    const SB_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
    const SB_KEY = 'sb_publishable_b2kTzbpSmcWVrpPUPFng7Q_enwqQd8u';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let user = { id: localStorage.getItem('mh_uid') || 'u_'+Math.floor(Math.random()*99999), role: 'guest', lat: 55.75, lon: 37.61 };
    if(!localStorage.getItem('mh_uid')) localStorage.setItem('mh_uid', user.id); // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID

    let state = { map: null, markers: {}, activeChat: null, currentReviewTask: null, reviewStars: 5 };

    // --- 1. –í–•–û–î –ò –ü–†–û–§–ò–õ–¨ ---
    async function login(role) {
        user.role = role;
        document.getElementById('scr-auth').style.display = 'none';
        document.getElementById('scr-main').style.display = 'block';

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é –ø–æ–¥ —Ä–æ–ª—å
        if(role === 'client') {
            document.getElementById('nav-create').style.display = 'block';
            document.getElementById('nav-my-orders').style.display = 'block';
            switchTab('create');
        } else {
            switchTab('feed');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        const { data } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
        if(!data) {
            await _supabase.from('profiles').insert([{ id: user.id, name: role==='client'?'–ó–∞–∫–∞–∑—á–∏–∫':'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å' }]);
        }
        loadProfile();

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        navigator.geolocation.getCurrentPosition(p => { user.lat = p.coords.latitude; user.lon = p.coords.longitude; });

        // –ó–ê–ü–£–°–ö REALTIME (–°–ï–†–î–¶–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø)
        initRealtime();
    }

    async function loadProfile() {
        const { data } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
        if(data) {
            document.getElementById('header-avatar').innerText = data.avatar;
            document.getElementById('profile-avatar').innerText = data.avatar;
            document.getElementById('profile-name').innerText = data.name;
            document.getElementById('profile-rating').innerText = data.rating;
            document.getElementById('edit-name').value = data.name;
            document.getElementById('edit-avatar').value = data.avatar;
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤
        const { data: revs } = await _supabase.from('reviews').select('*').eq('to_id', user.id);
        const list = document.getElementById('reviews-list');
        list.innerHTML = revs?.length ? '' : '<p style="font-size:12px; color:#999">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        revs?.forEach(r => {
            list.innerHTML += `<div class="card" style="padding:10px; margin-bottom:10px;"><b style="color:orange">${'‚òÖ'.repeat(r.stars)}</b><br>${r.comment}</div>`;
        });
    }

    async function saveProfile() {
        const name = document.getElementById('edit-name').value;
        const avatar = document.getElementById('edit-avatar').value;
        await _supabase.from('profiles').update({ name, avatar }).eq('id', user.id);
        alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        loadProfile();
    }

    // --- 2. REALTIME & –ó–ê–î–ê–ß–ò ---
    function initRealtime() {
        loadTasks(); // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        
        _supabase.channel('main-channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, payload => {
            console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –±–∞–∑–µ:', payload);
            loadTasks(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            
            // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–ü–£–ù–ö–¢ 2)
            if(payload.eventType === 'UPDATE') {
                const nav = payload.new;
                const old = payload.old;
                
                // –ï—Å–ª–∏ —è –∑–∞–∫–∞–∑—á–∏–∫ –∏ —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω–∏–ª—Å—è –Ω–∞ active -> –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω
                if(user.role === 'client' && nav.client_id === user.id && nav.status === 'active' && old.status === 'searching') {
                    showNotification(`üöÄ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω! –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç.`);
                }
                
                // –ï—Å–ª–∏ —è –∑–∞–∫–∞–∑—á–∏–∫ –∏ —Å—Ç–∞—Ç—É—Å completed -> –ü–æ—Ä–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                if(user.role === 'client' && nav.client_id === user.id && nav.status === 'completed') {
                    openReviewModal(nav.id, nav.worker_id);
                }

                // –ï—Å–ª–∏ —è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏ —Å—Ç–∞—Ç—É—Å completed
                if(user.role === 'worker' && nav.worker_id === user.id && nav.status === 'completed') {
                    openReviewModal(nav.id, nav.client_id);
                }
            }
        })
        .subscribe();
    }

    async function loadTasks() {
        const { data: tasks } = await _supabase.from('tasks').select('*').order('created_at', {ascending: false});
        renderFeed(tasks);
        renderMyOrders(tasks);
        updateMap(tasks);
    }

    // –õ–ï–ù–¢–ê (–î–õ–Ø –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø)
    function renderFeed(tasks) {
        const feed = document.getElementById('view-feed');
        feed.innerHTML = user.role === 'client' ? '<h3>–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–¥–µ–º–æ)</h3>' : '<h3>–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</h3>';
        
        tasks.forEach(t => {
            if(t.status === 'searching') {
                const card = createCard(t);
                feed.appendChild(card);
            }
        });
    }

    // –ú–û–ò –ó–ê–ö–ê–ó–´ (–î–õ–Ø –ó–ê–ö–ê–ó–ß–ò–ö–ê - –ü–£–ù–ö–¢ 1)
    function renderMyOrders(tasks) {
        const list = document.getElementById('view-my-orders');
        list.innerHTML = '<h3>–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3>';
        
        tasks.forEach(t => {
            if((user.role === 'client' && t.client_id === user.id) || (user.role === 'worker' && t.worker_id === user.id)) {
                const card = createCard(t);
                list.appendChild(card);
            }
        });
    }

    function createCard(t) {
        const div = document.createElement('div');
        div.className = 'card';
        
        let statusColor = t.status === 'searching' ? '#007AFF' : (t.status === 'active' ? '#FF9500' : '#34C759');
        let statusText = t.status === 'searching' ? '–ü–û–ò–°–ö' : (t.status === 'active' ? '–í –†–ê–ë–û–¢–ï' : '–ó–ê–í–ï–†–®–ï–ù–û');
        
        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        let actions = '';
        if(user.role === 'worker' && t.status === 'searching') {
            actions = `<button class="btn btn-p" onclick="takeTask('${t.id}')">–í–∑—è—Ç—å –∑–∞–∫–∞–∑</button>`;
        }
        if(t.status === 'active' && (t.client_id === user.id || t.worker_id === user.id)) {
            actions = `<button class="btn btn-o" onclick="openChat('${t.id}', '${t.title}')">üí¨ –ß–∞—Ç</button>`;
            if(user.role === 'client') {
                actions += `<button class="btn btn-g" style="margin-top:5px" onclick="completeTask('${t.id}')">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ü–µ–Ω–∏—Ç—å</button>`;
            }
        }
        if(t.status === 'completed') {
            actions = `<div style="text-align:center; color:green; font-weight:bold; margin-top:10px;">–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</div>`;
        }

        div.innerHTML = `
            <span class="badge" style="background:${statusColor}; color:white">${statusText}</span>
            <div style="font-weight:800; font-size:18px;">${t.title}</div>
            <div style="font-size:20px; color:var(--primary); font-weight:bold; margin:5px 0;">${t.price} ‚ÇΩ</div>
            ${actions}
        `;
        return div;
    }

    // --- 3. –î–ï–ô–°–¢–í–ò–Ø ---
    async function createTask() {
        const title = document.getElementById('inp-title').value;
        const price = document.getElementById('inp-price').value;
        if(!title || !price) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        
        await _supabase.from('tasks').insert([{
            title, price: parseInt(price), client_id: user.id, 
            status: 'searching', lat: user.lat, lon: user.lon
        }]);
        
        document.getElementById('inp-title').value = '';
        document.getElementById('inp-price').value = '';
        switchTab('my-orders');
        showNotification("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –ñ–¥–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.");
    }

    async function takeTask(id) {
        await _supabase.from('tasks').update({ status: 'active', worker_id: user.id }).eq('id', id);
    }

    async function completeTask(id) {
        if(confirm("–†–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞?")) {
            await _supabase.from('tasks').update({ status: 'completed' }).eq('id', id);
        }
    }

    // --- 4. –ö–ê–†–¢–ê (–ü–£–ù–ö–¢ 4) ---
    function updateMap(tasks) {
        if(!state.map && document.getElementById('map').offsetParent) {
            state.map = L.map('map').setView([user.lat, user.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(state.map);
        }
        if(!state.map) return;

        tasks.forEach(t => {
            if(t.status === 'searching' && !state.markers[t.id]) {
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
                const marker = L.marker([t.lat, t.lon]).addTo(state.map);
                marker.bindPopup(`
                    <div style="text-align:center">
                        <b>${t.title}</b><br>
                        <span style="font-size:16px; color:#007AFF; font-weight:bold">${t.price} ‚ÇΩ</span><br>
                        <button onclick="takeTask('${t.id}')" style="margin-top:5px; padding:5px; background:#007AFF; color:white; border:none; border-radius:5px;">–í–∑—è—Ç—å</button>
                    </div>
                `);
                state.markers[t.id] = marker;
            } else if (t.status !== 'searching' && state.markers[t.id]) {
                state.map.removeLayer(state.markers[t.id]);
                delete state.markers[t.id];
            }
        });
    }

    // --- 5. –û–¢–ó–´–í–´ (–ü–£–ù–ö–¢ 6) ---
    function openReviewModal(taskId, targetId) {
        state.currentReviewTask = { taskId, targetId };
        document.getElementById('review-modal').style.display = 'flex';
    }

    function setStar(n) {
        state.reviewStars = n;
        document.querySelectorAll('.star').forEach((s, i) => {
            s.classList.toggle('active', i < n);
        });
    }

    async function submitReview() {
        const text = document.getElementById('review-text').value;
        await _supabase.from('reviews').insert([{
            task_id: state.currentReviewTask.taskId,
            from_id: user.id,
            to_id: state.currentReviewTask.targetId,
            stars: state.reviewStars,
            comment: text
        }]);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –≤ –ë–î, –∑–¥–µ—Å—å —É–ø—Ä–æ—â–µ–Ω–Ω–æ –Ω–µ –¥–µ–ª–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç, –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤)
        
        document.getElementById('review-modal').style.display = 'none';
        showNotification("–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!");
    }

    // --- 6. –ß–ê–¢ ---
    async function openChat(id, title) {
        state.activeChat = id;
        document.getElementById('chat-ui').style.display = 'flex';
        document.getElementById('chat-title').innerText = title;
        loadMsgs();
        _supabase.channel('chat-'+id).on('postgres_changes', {event:'INSERT', schema:'public', table:'messages', filter:`task_id=eq.${id}`}, loadMsgs).subscribe();
    }
    async function loadMsgs() {
        const { data } = await _supabase.from('messages').select('*').eq('task_id', state.activeChat).order('created_at');
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        data.forEach(m => {
            box.innerHTML += `<div class="msg ${m.sender_id === user.id ? 'me' : 'other'}">${m.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }
    async function sendMsg() {
        const text = document.getElementById('chat-inp').value;
        if(!text) return;
        await _supabase.from('messages').insert([{ task_id: state.activeChat, sender_id: user.id, text }]);
        document.getElementById('chat-inp').value = '';
    }
    function closeChat() { document.getElementById('chat-ui').style.display = 'none'; }

    // –£–¢–ò–õ–ò–¢–´
    function switchTab(tab) {
        document.querySelectorAll('.container').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        
        // –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –¥–ª—è –∫–∞—Ä—Ç—ã
        const view = document.getElementById('view-'+tab);
        if(view) view.style.display = 'block';
        
        // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∞, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä Leaflet
        if(tab === 'map') {
            document.getElementById('view-map').style.display = 'block';
            setTimeout(() => state.map.invalidateSize(), 200);
        }

        const nav = document.getElementById('nav-'+tab);
        if(nav) nav.classList.add('active');
        
        document.getElementById('page-title').innerText = nav ? nav.innerText : '–ú–∏–∫—Ä–æ–ü–æ–º–æ—â—å';
    }

    function showNotification(text) {
        const el = document.getElementById('notification');
        el.innerText = text;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }
</script>
</body>
</html>
