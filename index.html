<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∏–∫—Ä–æ–ü–æ–º–æ—â—å | –ì–∏–ø–µ—Ä–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #007AFF; 
            --bg: #F2F2F7; 
            --surface: #FFFFFF; 
            --text-main: #1C1C1E; 
            --text-sec: #8E8E93;
            --green: #34C759; 
            --orange: #FF9500;
            --danger: #FF3B30;
        }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        
        /* UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ */
        .header { background: var(--surface); padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 900; font-size: 20px; color: var(--primary); letter-spacing: -0.5px; }
        
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        .card { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.03); }
        .card:active { transform: scale(0.98); }
        
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-success { background: var(--green); color: white; }
        
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #E5E5EA; background: #F9F9F9; box-sizing: border-box; font-family: inherit; font-size: 16px; }
        
        /* –ö–ê–¢–ï–ì–û–†–ò–ò */
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cat-item { background: white; border-radius: 12px; padding: 10px 5px; text-align: center; border: 1px solid #EEE; cursor: pointer; }
        .cat-item.selected { border-color: var(--primary); background: #E5F1FF; color: var(--primary); }
        .cat-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .cat-name { font-size: 10px; font-weight: 700; }

        /* –ú–ï–ù–Æ –ò –ö–ê–†–¢–ê */
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #EEE; z-index: 999; }
        .nav-item { text-align: center; font-size: 10px; color: var(--text-sec); font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }
        
        #map { height: 350px; width: 100%; border-radius: 20px; margin-bottom: 20px; z-index: 1; }
        
        /* –ß–ê–¢ */
        #chat-ui { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; }
        .chat-header { padding: 15px; border-bottom: 1px solid #EEE; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #F2F2F7; }
        .msg-bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: white; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* –°–¢–ê–¢–£–°–´ –ò –¶–ï–ù–´ */
        .price-tag { font-size: 18px; font-weight: 800; color: var(--primary); }
        .commission-info { font-size: 12px; color: var(--text-sec); display: block; margin-top: 2px; }
        .status-badge { padding: 6px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; float: right; }
    </style>
</head>
<body>

<div id="scr-auth" style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; background: white;">
    <div style="font-size: 60px; margin-bottom: 20px;">ü§ù</div>
    <h1 style="margin: 0; font-size: 32px; font-weight: 900;">–ú–∏–∫—Ä–æ–ü–æ–º–æ—â—å</h1>
    <p style="color: var(--text-sec); margin-bottom: 40px;">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –±—ã—Ç–æ–≤—ã—Ö —É—Å–ª—É–≥</p>
    
    <button class="btn btn-primary" onclick="initApp('client')">–Ø –ó–∞–∫–∞–∑—á–∏–∫ (–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å)</button>
    <button class="btn btn-outline" onclick="initApp('worker')">–Ø –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–ò—â—É –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É)</button>
</div>

<div id="scr-main" style="display: none;">
    <div class="header">
        <div class="logo">–ú–∏–∫—Ä–æ–ü–æ–º–æ—â—å</div>
        <div style="text-align: right;">
            <div id="user-balance" style="font-weight: 800;">0 ‚ÇΩ</div>
            <div id="user-role" style="font-size: 10px; color: var(--text-sec);"></div>
        </div>
    </div>

    <div class="nav-bottom">
        <div class="nav-item active" onclick="switchTab('feed')" id="nav-feed">
            <span class="nav-icon">üîç</span>–ü–æ–∏—Å–∫
        </div>
        <div class="nav-item" onclick="switchTab('map')" id="nav-map">
            <span class="nav-icon">üó∫</span>–ö–∞—Ä—Ç–∞
        </div>
        <div class="nav-item" onclick="switchTab('create')" id="nav-create" style="display:none">
            <span class="nav-icon">‚ûï</span>–°–æ–∑–¥–∞—Ç—å
        </div>
        <div class="nav-item" onclick="alert('–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
            <span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å
        </div>
    </div>

    <div class="container" style="padding-bottom: 100px;">
        
        <div id="view-create" style="display:none">
            <h2 style="margin-top: 0;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h2>
            <div class="card">
                <label style="font-size: 12px; font-weight: 700; color: var(--text-sec); margin-bottom: 10px; display: block;">–ö–ê–¢–ï–ì–û–†–ò–Ø</label>
                <div class="cat-grid">
                    <div class="cat-item" onclick="selectCat(this, 'cleaning')"><span class="cat-icon">üßπ</span><span class="cat-name">–£–±–æ—Ä–∫–∞</span></div>
                    <div class="cat-item" onclick="selectCat(this, 'courier')"><span class="cat-icon">üì¶</span><span class="cat-name">–ö—É—Ä—å–µ—Ä</span></div>
                    <div class="cat-item" onclick="selectCat(this, 'repair')"><span class="cat-icon">üõ†</span><span class="cat-name">–†–µ–º–æ–Ω—Ç</span></div>
                    <div class="cat-item" onclick="selectCat(this, 'pets')"><span class="cat-icon">ü¶Æ</span><span class="cat-name">–í—ã–≥—É–ª</span></div>
                </div>

                <input id="inp-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å? (–ù–∞–ø—Ä–∏–º–µ—Ä: –í—ã–≥—É–ª—è—Ç—å –ø—Å–∞)">
                <textarea id="inp-desc" rows="3" placeholder="–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏: –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫–∏, –∫–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞..."></textarea>
                
                <div style="display: flex; gap: 10px;">
                    <input id="inp-price" type="number" placeholder="–ë—é–¥–∂–µ—Ç (‚ÇΩ)" style="font-weight: 700;">
                    <div style="padding: 14px; background: #E5F1FF; border-radius: 12px; font-size: 12px; display: flex; align-items: center; color: var(--primary);">
                        –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞ 0% –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞
                    </div>
                </div>

                <button class="btn btn-primary" onclick="publishTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏ –Ω–∞–π—Ç–∏ –ø–æ–º–æ—â–Ω–∏–∫–∞</button>
            </div>
        </div>

        <div id="view-map" style="display:none">
            <div id="map"></div>
            <div style="text-align: center; color: var(--text-sec); font-size: 12px;">–ü–æ–∫–∞–∑–∞–Ω—ã –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–¥–∏—É—Å–µ 2 –∫–º</div>
        </div>

        <div id="view-feed">
            <h3 id="feed-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
            <div id="feed-list"></div>
        </div>
    </div>
</div>

<div id="chat-ui">
    <div class="chat-header">
        <button onclick="closeChat()" style="border:none; background:none; font-size: 24px;">‚úï</button>
        <div>
            <div id="chat-title-main">–ß–∞—Ç –∑–∞–∫–∞–∑–∞</div>
            <div style="font-size: 12px; color: var(--text-sec);">–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–¥–µ–ª–∫–∞</div>
        </div>
    </div>
    <div id="chat-box" class="chat-msgs"></div>
    <div style="padding: 15px; background: white; border-top: 1px solid #EEE; display: flex; gap: 10px;">
        <input id="chat-inp" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
        <button onclick="sendMessage()" class="btn btn-primary" style="width: auto; margin:0; padding: 0 20px;">‚û§</button>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const SB_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
    const SB_KEY = 'sb_publishable_b2kTzbpSmcWVrpPUPFng7Q_enwqQd8u';
    const COMMISSION_RATE = 0.15; // 15% –∫–æ–º–∏—Å—Å–∏—è

    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let state = {
        user: { id: 'u_'+Math.floor(Math.random()*100000), role: 'guest', lat: 55.75, lon: 37.61, balance: 10000 },
        activeCategory: null,
        activeChatId: null,
        map: null,
        markers: {}
    };

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function initApp(role) {
        state.user.role = role;
        
        // UI –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        document.getElementById('scr-auth').style.display = 'none';
        document.getElementById('scr-main').style.display = 'block';
        document.getElementById('user-role').innerText = role === 'client' ? '–ó–∞–∫–∞–∑—á–∏–∫' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å';
        document.getElementById('user-balance').innerText = state.user.balance + ' ‚ÇΩ';

        if (role === 'client') {
            document.getElementById('nav-create').style.display = 'block';
            document.getElementById('feed-title').innerText = '–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è';
            switchTab('create');
        } else {
            switchTab('feed');
        }

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        navigator.geolocation.getCurrentPosition(pos => {
            state.user.lat = pos.coords.latitude;
            state.user.lon = pos.coords.longitude;
            initMap(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        }, () => initMap()); // –ò–ª–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏

        // –ó–∞–ø—É—Å–∫ Realtime
        loadTasks();
        _supabase.channel('main').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, loadTasks).subscribe();
    }

    function initMap() {
        if (state.map) return;
        state.map = L.map('map').setView([state.user.lat, state.user.lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(state.map);
        
        // –ú–∞—Ä–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∏–Ω–∏–π –∫—Ä—É–≥)
        L.circleMarker([state.user.lat, state.user.lon], { radius: 8, color: '#007AFF', fillColor: '#007AFF', fillOpacity: 0.5 }).addTo(state.map)
         .bindPopup("–í—ã –∑–¥–µ—Å—å");
    }

    // --- –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–ê ---
    
    async function publishTask() {
        const title = document.getElementById('inp-title').value;
        const desc = document.getElementById('inp-desc').value;
        const price = document.getElementById('inp-price').value;
        
        if (!title || !price || !state.activeCategory) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é");

        const { error } = await _supabase.from('tasks').insert([{
            title, 
            description: desc,
            price: parseInt(price),
            category: state.activeCategory,
            client_id: state.user.id,
            status: 'searching',
            lat: state.user.lat, // –î–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –±–µ—Ä–µ–º —Ç–µ–∫—É—â—É—é —Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            lon: state.user.lon
        }]);

        if (error) alert("–û—à–∏–±–∫–∞: " + error.message);
        else {
            alert("–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω! –î–µ–Ω—å–≥–∏ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã.");
            // –ò–º–∏—Ç–∞—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è
            state.user.balance -= price;
            updateBalanceUI();
            
            // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-price').value = '';
            switchTab('feed'); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É
        }
    }

    async function loadTasks() {
        const { data: tasks } = await _supabase.from('tasks').select('*').order('created_at', { ascending: false });
        renderFeed(tasks || []);
        updateMapMarkers(tasks || []);
    }

    function renderFeed(tasks) {
        const list = document.getElementById('feed-list');
        list.innerHTML = '';

        tasks.forEach(task => {
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –ó–∞–∫–∞–∑—á–∏–∫ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏, –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ + —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ
            let isVisible = false;
            if (state.user.role === 'client' && task.client_id === state.user.id) isVisible = true;
            if (state.user.role === 'worker' && (task.status === 'searching' || task.worker_id === state.user.id)) isVisible = true;

            if (!isVisible) return;

            // –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏
            const income = Math.floor(task.price * (1 - COMMISSION_RATE));
            const distance = getDistanceInKm(state.user.lat, state.user.lon, task.lat, task.lon).toFixed(1);

            const card = document.createElement('div');
            card.className = 'card';
            
            let statusBadge = '';
            let actionBtn = '';

            // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤
            if (task.status === 'searching') {
                statusBadge = '<span class="status-badge" style="background:#E5F1FF; color:var(--primary)">–ü–û–ò–°–ö</span>';
                if (state.user.role === 'worker') {
                    actionBtn = `<button class="btn btn-primary" onclick="takeTask('${task.id}')">–í–∑—è—Ç—å –∑–∞–∫–∞–∑ (–î–æ—Ö–æ–¥: ${income} ‚ÇΩ)</button>`;
                }
            } else if (task.status === 'active') {
                statusBadge = '<span class="status-badge" style="background:#FFF4E5; color:var(--orange)">–í –†–ê–ë–û–¢–ï</span>';
                actionBtn = `<button class="btn btn-outline" onclick="openChat('${task.id}', '${task.title}')">üí¨ –ß–∞—Ç —Å ${state.user.role === 'client' ? '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º' : '–∑–∞–∫–∞–∑—á–∏–∫–æ–º'}</button>`;
                
                if (state.user.role === 'client') {
                    actionBtn += `<button class="btn btn-success" style="margin-top:5px" onclick="finishTask('${task.id}', ${task.price})">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</button>`;
                }
            } else {
                statusBadge = '<span class="status-badge" style="background:#E8F8EE; color:var(--green)">–í–´–ü–û–õ–ù–ï–ù–û</span>';
            }

            card.innerHTML = `
                ${statusBadge}
                <div style="font-size: 24px; margin-bottom: 5px;">${getCatIcon(task.category)}</div>
                <div style="font-weight: 800; font-size: 18px; margin-bottom: 5px;">${task.title}</div>
                <div style="color: var(--text-sec); font-size: 14px; margin-bottom: 10px;">${task.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-sec);">üìç ${distance} –∫–º –æ—Ç –≤–∞—Å</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="price-tag">${task.price} ‚ÇΩ</div>
                        ${state.user.role === 'worker' ? `<span class="commission-info">–ß–∏—Å—Ç—ã–º–∏: ${income} ‚ÇΩ</span>` : ''}
                    </div>
                </div>
                ${actionBtn}
            `;
            list.appendChild(card);
        });
    }

    async function takeTask(id) {
        if (!confirm("–í–∑—è—Ç—å –∑–∞–∫–∞–∑ –≤ —Ä–∞–±–æ—Ç—É? –°—É–º–º–∞ –±—É–¥–µ—Ç –∑–∞—Ö–æ–ª–¥–∏—Ä–æ–≤–∞–Ω–∞.")) return;
        await _supabase.from('tasks').update({ status: 'active', worker_id: state.user.id }).eq('id', id);
    }

    async function finishTask(id, amount) {
        if (!confirm("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ? –î–µ–Ω—å–≥–∏ —É–π–¥—É—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é.")) return;
        await _supabase.from('tasks').update({ status: 'completed' }).eq('id', id);
        alert("–ó–∞–∫–∞–∑ –∑–∞–∫—Ä—ã—Ç! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ú–∏–∫—Ä–æ–ü–æ–º–æ—â—å.");
    }

    // --- –ß–ê–¢ ---
    async function openChat(taskId, title) {
        state.activeChatId = taskId;
        document.getElementById('chat-ui').style.display = 'flex';
        document.getElementById('chat-title-main').innerText = title;
        loadMessages();
        _supabase.channel('chat_'+taskId).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `task_id=eq.${taskId}` }, loadMessages).subscribe();
    }

    async function loadMessages() {
        const { data } = await _supabase.from('messages').select('*').eq('task_id', state.activeChatId).order('created_at');
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        data.forEach(m => {
            const el = document.createElement('div');
            el.className = `msg-bubble ${m.sender_id === state.user.id ? 'msg-me' : 'msg-other'}`;
            el.innerText = m.text;
            box.appendChild(el);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
        const txt = document.getElementById('chat-inp').value;
        if (!txt) return;
        await _supabase.from('messages').insert([{ task_id: state.activeChatId, sender_id: state.user.id, text: txt }]);
        document.getElementById('chat-inp').value = '';
    }

    function closeChat() { document.getElementById('chat-ui').style.display = 'none'; }

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    
    function updateMapMarkers(tasks) {
        if (!state.map) return;
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö (—É–ø—Ä–æ—â–µ–Ω–Ω–æ: –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ)
        tasks.forEach(t => {
            if (t.status === 'searching') {
                const icon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background:var(--primary); color:white; padding:5px; border-radius:8px; font-weight:bold; font-size:12px; width:40px; text-align:center;">${t.price}</div>`
                });
                L.marker([t.lat + (Math.random()*0.002), t.lon + (Math.random()*0.002)], {icon: icon}) // –°–º–µ—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å
                 .addTo(state.map)
                 .bindPopup(`<b>${t.title}</b><br>${t.description}<br><button onclick="takeTask('${t.id}')">–í–∑—è—Ç—å</button>`);
            }
        });
    }

    function switchTab(tab) {
        ['feed', 'map', 'create'].forEach(t => {
            const el = document.getElementById('view-'+t);
            const nav = document.getElementById('nav-'+t);
            if (el) el.style.display = (t === tab) ? 'block' : 'none';
            if (nav) nav.classList.toggle('active', t === tab);
        });
        if (tab === 'map' && state.map) setTimeout(() => state.map.invalidateSize(), 200);
    }

    function selectCat(el, cat) {
        document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        state.activeCategory = cat;
    }

    function getCatIcon(cat) {
        const map = { 'cleaning': 'üßπ', 'courier': 'üì¶', 'repair': 'üõ†', 'pets': 'ü¶Æ' };
        return map[cat] || 'üìã';
    }

    function updateBalanceUI() { document.getElementById('user-balance').innerText = state.user.balance + ' ‚ÇΩ'; }

    // –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞ –¥–ª—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–∫–º)
    function getDistanceInKm(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2-lat1) * (Math.PI/180);
        const dLon = (lon2-lon1) * (Math.PI/180);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
</script>
</body>
</html>
