<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 1. Настройки (Возьми их в Supabase: Settings -> API)
    const SUPABASE_URL = 'ТВОЙ_URL';
    const SUPABASE_KEY = 'ТВОЙ_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let userId = 'user_' + Math.floor(Math.random() * 10000);
    let userRole = '';

    function selectRole(role) {
        userRole = role;
        document.getElementById('screen-auth').style.display = 'none';
        document.getElementById('screen-app').style.display = 'block';
        startRealtime();
        renderTasks(); // Первичная загрузка
    }

    // 2. Реальное время (Real-time)
    function startRealtime() {
        supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
                console.log('Изменение в базе!', payload);
                renderTasks();
                if(payload.eventType === 'INSERT' && userRole === 'worker') playSound('new_task');
            })
            .subscribe();
    }

    // 3. Функция загрузки заказов
    async function renderTasks() {
        const { data: tasks, error } = await supabase.from('tasks').select('*').order('created_at', { ascending: false });
        if (error) return console.error(error);

        const cList = document.getElementById('client-list');
        const wFeed = document.getElementById('worker-feed');
        cList.innerHTML = ''; wFeed.innerHTML = '';

        tasks.forEach(t => {
            const card = `
                <div class="card">
                    <span class="status-badge">${t.status}</span>
                    <b>${t.title}</b><br>${t.price} ₽
                    ${userRole === 'client' && t.status === 'searching' ? `<button onclick="alert('Ждем исполнителя')">В поиске...</button>` : ''}
                    ${userRole === 'worker' && t.status === 'searching' ? `<button class="btn btn-main" onclick="apply('${t.id}')">Откликнуться</button>` : ''}
                </div>`;
            
            if (t.client_id === userId) cList.innerHTML += card;
            if (t.status === 'searching') wFeed.innerHTML += card;
        });
    }

    // 4. Создание задачи
    async function createTask() {
        const title = document.getElementById('t-title').value;
        const price = document.getElementById('t-price').value;
        await supabase.from('tasks').insert([{ title, price, client_id: userId, status: 'searching' }]);
        document.getElementById('t-title').value = '';
    }

    async function apply(id) {
        await supabase.from('tasks').update({ status: 'active', worker_id: userId }).eq('id', id);
        alert("Вы взяли заказ!");
    }
</script>
