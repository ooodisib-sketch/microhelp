<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroHelp - –ó–∞–∫–∞–∑—ã –º–∏–∫—Ä–æ-–ø–æ–º–æ—â–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #818CF8;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-light: #FFFFFF;
            --bg-dark: #0F172A;
            --map-bg-light: #F8FAFC;
            --map-bg-dark: #1E293B;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --text-color: #1E293B;
            --map-bg: var(--map-bg-light);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --text-color: #F1F5F9;
            --map-bg: var(--map-bg-dark);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* –ú–æ–¥–∞–ª–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .auth-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .auth-container {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 40px;
            border-radius: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .auth-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            background: white;
            color: var(--primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-input {
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }
        
        .auth-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }
        
        .auth-btn {
            width: 100%;
            padding: 15px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.3s;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .auth-switch {
            color: white;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .role-option {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .role-option.active {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* –ü–∞–Ω–µ–ª—å —Å–±–æ–∫—É */
        .side-panel {
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] .side-panel {
            background: rgba(15, 23, 42, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .side-panel.hidden {
            transform: translateX(-100%);
        }

        .panel-toggle {
            position: absolute;
            right: -50px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            z-index: 1001;
            transition: all 0.3s;
        }

        .panel-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ */
        .panel-header {
            padding: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .panel-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, 20px); }
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            backdrop-filter: blur(10px);
        }

        .logo-text {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-top: 20px;
            position: relative;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π */
        .role-switcher {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 4px;
            margin: 20px 30px;
            display: flex;
            backdrop-filter: blur(10px);
        }

        .role-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .role-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        /* –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ */
        .orders-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .order-card {
            background: var(--bg-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .order-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.2);
        }

        .order-card.active {
            border: 2px solid var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .order-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-color);
            flex: 1;
        }

        .order-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--success);
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .order-meta {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #64748B;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .order-description {
            color: var(--text-color);
            opacity: 0.8;
            line-height: 1.5;
            margin: 15px 0;
            font-size: 14px;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background: var(--map-bg);
            transition: background 0.3s;
        }

        /* –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Ç–∞–π–ª–æ–≤ –∫–∞—Ä—Ç—ã */
        .custom-tile-layer {
            filter: saturate(1.2) contrast(1.1) brightness(1.05);
        }

        [data-theme="dark"] .custom-tile-layer {
            filter: invert(1) hue-rotate(180deg) saturate(1.5) brightness(0.8) contrast(1.2);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π */
        .map-controls {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .map-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: none;
            color: var(--primary);
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] .map-control-btn {
            background: rgba(15, 23, 42, 0.95);
            color: white;
        }

        .map-control-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 40px rgba(79, 70, 229, 0.2);
        }

        .map-control-btn.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3); }
            50% { box-shadow: 0 8px 32px rgba(79, 70, 229, 0.6); }
            100% { box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3); }
        }

        /* –ü–æ–∏—Å–∫ */
        .search-container {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            max-width: 90%;
            z-index: 1000;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 20px 60px 20px 30px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            font-size: 16px;
            color: var(--text-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        [data-theme="dark"] .search-input {
            background: rgba(15, 23, 42, 0.95);
            color: white;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3);
        }

        .search-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
        }

        /* –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã */
        .custom-marker {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            transform-origin: center;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .marker-order {
            background: linear-gradient(135deg, var(--warning) 0%, #F59E0B 100%);
        }

        .marker-order::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            z-index: -1;
            animation: pulseRing 2s infinite;
        }

        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .marker-customer {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .marker-master {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ */
        .map-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }

        [data-theme="dark"] .map-info {
            background: rgba(15, 23, 42, 0.95);
            color: white;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
        }

        .info-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .info-close:hover {
            opacity: 1;
        }

        /* –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .order-modal.active {
            display: flex;
        }

        .order-modal-content {
            background: var(--bg-color);
            padding: 30px;
            border-radius: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 16px;
        }

        [data-theme="dark"] .form-control {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .photo-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .photo-upload:hover {
            border-color: var(--primary);
        }

        .photo-upload i {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .preview-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ß–∞—Ç */
        .chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
        }

        .chat-modal.active {
            display: flex;
        }

        .chat-container {
            background: var(--bg-color);
            border-radius: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .message.outgoing {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.incoming {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(79, 70, 229, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* –°–∫–µ–ª–µ—Ç–æ–Ω—ã */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 10px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-order {
            height: 150px;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
        .animated-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(79, 70, 229, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            animation: gradientShift 15s ease infinite;
            z-index: -1;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .side-panel {
                width: 350px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .side-panel {
                width: 100%;
                height: 60vh;
                position: absolute;
                bottom: 0;
                border-right: none;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .side-panel.hidden {
                transform: translateY(100%);
            }
            
            .panel-toggle {
                right: 20px;
                top: -60px;
            }
            
            .map-container {
                height: 40vh;
            }
            
            .search-container {
                width: 90%;
                top: 20px;
            }
            
            .map-controls {
                top: 20px;
                right: 20px;
            }
            
            .map-control-btn {
                width: 50px;
                height: 50px;
            }
            
            .auth-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <div class="auth-modal active" id="authModal">
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div class="auth-form active" id="loginForm">
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email" autocomplete="email">
                <input type="password" class="auth-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
                <button class="auth-btn" onclick="login()">–í–æ–π—Ç–∏</button>
                <div class="auth-footer">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="auth-switch" onclick="switchAuthTab('register')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</span>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="auth-form" id="registerForm">
                <div class="role-selector">
                    <div class="role-option active" onclick="selectRole('customer')">
                        <i class="fas fa-shopping-cart"></i>
                        <div>–ó–∞–∫–∞–∑—á–∏–∫</div>
                    </div>
                    <div class="role-option" onclick="selectRole('master')">
                        <i class="fas fa-tools"></i>
                        <div>–ú–∞—Å—Ç–µ—Ä</div>
                    </div>
                </div>
                <input type="text" class="auth-input" id="registerName" placeholder="–ò–º—è">
                <input type="email" class="auth-input" id="registerEmail" placeholder="Email">
                <input type="password" class="auth-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button class="auth-btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div class="auth-footer">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="auth-switch" onclick="switchAuthTab('login')">–í–æ–π–¥–∏—Ç–µ</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω -->
    <div class="animated-bg"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="app-container" id="mainInterface" style="display: none;">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="side-panel" id="sidePanel">
            <button class="panel-toggle" onclick="toggleSidePanel()">
                <i class="fas fa-chevron-left" id="panelToggleIcon"></i>
            </button>
            
            <div class="panel-header">
                <div class="app-logo">
                    <div class="logo-icon">
                        <i class="fas fa-hands-helping"></i>
                    </div>
                    <div class="logo-text">MicroHelp</div>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div style="font-weight: 600;" id="userName">–ì–æ—Å—Ç—å</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="userRole">–ó–∞–∫–∞–∑—á–∏–∫</div>
                    </div>
                    <button class="logout-btn" onclick="logout()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: auto;" title="–í—ã–π—Ç–∏">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π -->
            <div class="role-switcher">
                <button class="role-btn active" onclick="switchRole('customer')">
                    <i class="fas fa-shopping-cart"></i>
                    <span>–ó–∞–∫–∞–∑—á–∏–∫</span>
                </button>
                <button class="role-btn" onclick="switchRole('master')">
                    <i class="fas fa-tools"></i>
                    <span>–ú–∞—Å—Ç–µ—Ä</span>
                </button>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ -->
            <div class="panel-content">
                <h2 class="section-title" id="panelTitle">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="titleText">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</span>
                    <span style="margin-left: auto; font-size: 14px; color: var(--primary);" id="ordersCount">0</span>
                </h2>
                
                <div id="ordersList" class="orders-grid">
                    <!-- –ó–∞–∫–∞–∑—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="addressSearch" 
                           placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –º–µ—Å—Ç–∞..."
                           onkeypress="searchKeyPress(event)">
                    <button class="search-btn" onclick="searchAddress()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
            <div class="map-controls">
                <button class="map-control-btn" onclick="centerMap()" title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="map-control-btn pulse" onclick="openNewOrderModal()" id="newOrderBtn" title="–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="map-control-btn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="map-control-btn" onclick="openProfileModal()" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <i class="fas fa-user-cog"></i>
                </button>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ -->
            <div class="map-info" id="mapInfo">
                <div class="info-header">
                    <div class="info-title" id="infoTitle"></div>
                    <button class="info-close" onclick="closeInfo()">√ó</button>
                </div>
                <div id="infoContent"></div>
                <div class="order-actions" id="infoActions" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
    <div class="order-modal" id="newOrderModal">
        <div class="order-modal-content">
            <button class="modal-close" onclick="closeNewOrderModal()">√ó</button>
            <h2 class="modal-title">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" id="orderTitle" class="form-control" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="orderDescription" class="form-control" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</label>
                <input type="number" id="orderPrice" class="form-control" placeholder="500" min="100" step="100">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="orderAddress" class="form-control" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
            </div>
            
            <div class="form-group">
                <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <div class="photo-upload" onclick="document.getElementById('orderPhotos').click()">
                    <i class="fas fa-camera"></i>
                    <div>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤</div>
                </div>
                <input type="file" id="orderPhotos" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload()">
                <div class="photo-preview" id="photoPreview"></div>
            </div>
            
            <div class="order-actions">
                <button class="btn btn-outline" onclick="closeNewOrderModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="createOrder()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="order-modal" id="profileModal">
        <div class="order-modal-content">
            <button class="modal-close" onclick="closeProfileModal()">√ó</button>
            <h2 class="modal-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            
            <div class="form-group">
                <label class="form-label">–ò–º—è</label>
                <input type="text" id="profileName" class="form-control" placeholder="–í–∞—à–µ –∏–º—è">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="profilePhone" class="form-control" placeholder="+7 (999) 123-45-67">
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="profileDescription" class="form-control" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."></textarea>
            </div>
            
            <div class="order-actions">
                <button class="btn btn-outline" onclick="closeProfileModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-container">
            <div class="chat-header">
                <h3 id="chatTitle">–ß–∞—Ç –∑–∞–∫–∞–∑–∞</h3>
                <button onclick="closeChat()" style="background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="chatKeyPress(event)">
                <button class="btn btn-primary" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <input type="file" id="chatPhotoInput" accept="image/*" style="display: none;">
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
        // ===================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====================
        const SUPABASE_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yaG92bWFieWF3YmZ6Y3h3bWliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NDEzNjAsImV4cCI6MjA4NDExNzM2MH0.lagPVLLopst3yx5eiuJchwOP4wJg49cEqmWZrNWxFrQ';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized');
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }
        
        // ===================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø HTML =====================
        window.switchAuthTab = function(tab) {
            console.log('Switch tab to:', tab);
            
            document.querySelectorAll('.auth-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        };
        
        window.selectRole = function(role) {
            console.log('Select role:', role);
            
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('active');
            });
            
            event.target.closest('.role-option').classList.add('active');
        };
        
        window.login = async function() {
            console.log('Login function called');
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–∏–∂–µ
        };
        
        window.register = async function() {
            console.log('Register function called');
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–∏–∂–µ
        };
        
        // ===================== –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====================
        const state = {
            user: null,
            role: 'customer',
            map: null,
            currentPosition: null,
            markers: new Map(),
            selectedOrder: null,
            orders: [],
            sidePanelOpen: true,
            theme: localStorage.getItem('microhelp_theme') || 'light',
            authTab: 'login',
            selectedRegisterRole: 'customer',
            subscriptions: [],
            selectedLocation: null,
            selectedMarker: null,
            photos: [],
            activeChatOrderId: null,
            currentMarker: null
        };

        // ===================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing app...');
            await initApp();
        });

        async function initApp() {
            console.log('Starting app initialization...');
            showLoading();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—É
            loadTheme();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (user) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    state.user = user;
                    console.log('User found:', user.email);
                    await loadUserProfile();
                    hideAuthModal();
                    showMainInterface();
                    initMap();
                    await loadOrders();
                    setupRealtimeSubscriptions();
                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    console.log('No user found, showing auth modal');
                    showAuthModal();
                    initMap();
                }
            } catch (error) {
                console.error('Error checking user status:', error);
                showAuthModal();
                initMap();
            }
            
            hideLoading();
            setupEventListeners();
            console.log('App initialization complete');
        }

        // ===================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====================
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function showMainInterface() {
            document.getElementById('mainInterface').style.display = 'flex';
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é login
        window.login = async function() {
            showLoading();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                hideLoading();
                return;
            }
            
            try {
                console.log('Attempting login for:', email);
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                console.log('Login successful:', data.user.email);
                state.user = data.user;
                await loadUserProfile();
                hideAuthModal();
                showMainInterface();
                initMap();
                await loadOrders();
                setupRealtimeSubscriptions();
                showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                
            } catch (error) {
                console.error('Login error:', error);
                showToast(error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
            
            hideLoading();
        };

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é register
        window.register = async function() {
            showLoading();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name || !email || !password || !confirmPassword) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                hideLoading();
                return;
            }
            
            if (password.length < 6) {
                showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                hideLoading();
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                hideLoading();
                return;
            }
            
            try {
                console.log('Attempting registration for:', email);
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name: name,
                            role: state.selectedRegisterRole
                        }
                    }
                });
                
                if (error) throw error;

                console.log('Registration successful:', data.user?.email);
                showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                switchAuthTab('login');
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast(error.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
            
            hideLoading();
        };

        window.logout = async function() {
            showLoading();
            
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
            state.subscriptions.forEach(subscription => {
                subscription.unsubscribe();
            });
            state.subscriptions = [];
            
            // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
            try {
                await supabaseClient.auth.signOut();
                state.user = null;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('mainInterface').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                showAuthModal();
                showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            }
            
            hideLoading();
        };

        // ===================== –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø =====================
        async function loadUserProfile() {
            if (!state.user) return;
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', state.user.id)
                    .single();
                
                if (error) {
                    console.error('Error loading profile:', error);
                    // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                    if (error.code === 'PGRST116') {
                        await createUserProfile();
                        return;
                    }
                    return;
                }
                
                if (profile) {
                    state.role = profile.role || 'customer';
                    updateUserInterface(profile);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function createUserProfile() {
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .insert([
                        {
                            id: state.user.id,
                            name: state.user.user_metadata?.name || state.user.email?.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            role: state.user.user_metadata?.role || 'customer',
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (error) throw error;
                
                console.log('Profile created successfully');
                await loadUserProfile();
                
            } catch (error) {
                console.error('Error creating profile:', error);
            }
        }

        function updateUserInterface(profile) {
            if (!state.user) return;
            
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            const name = profile?.name || state.user.user_metadata?.name || state.user.email?.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const role = state.role === 'customer' ? '–ó–∞–∫–∞–∑—á–∏–∫' : '–ú–∞—Å—Ç–µ—Ä';
            
            if (userAvatar) userAvatar.textContent = name.charAt(0).toUpperCase();
            if (userName) userName.textContent = name;
            if (userRole) userRole.textContent = role;
            
            const titleText = document.getElementById('titleText');
            if (titleText) {
                titleText.textContent = state.role === 'customer' ? '–ú–æ–∏ –∑–∞–∫–∞–∑—ã' : '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã';
            }
            
            const newOrderBtn = document.getElementById('newOrderBtn');
            if (newOrderBtn) {
                newOrderBtn.style.display = state.role === 'customer' ? 'block' : 'none';
            }
        }

        window.openProfileModal = function() {
            loadProfileData();
            document.getElementById('profileModal').classList.add('active');
        };

        async function loadProfileData() {
            if (!state.user) return;
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', state.user.id)
                    .single();
                
                if (!error && profile) {
                    document.getElementById('profileName').value = profile.name || '';
                    document.getElementById('profilePhone').value = profile.phone || '';
                    document.getElementById('profileDescription').value = profile.description || '';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        window.saveProfile = async function() {
            showLoading();
            
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const description = document.getElementById('profileDescription').value.trim();
            
            if (!name) {
                showToast('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
                hideLoading();
                return;
            }
            
            try {
                const updateData = {
                    name: name,
                    updated_at: new Date().toISOString()
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
                if (phone) updateData.phone = phone;
                if (description) updateData.description = description;
                
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(updateData)
                    .eq('id', state.user.id);
                
                if (error) throw error;
                
                showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                closeProfileModal();
                await loadUserProfile();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
            }
            
            hideLoading();
        };

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.remove('active');
        };

        // ===================== –ö–ê–†–¢–ê –ò –ì–ï–û–õ–û–ö–ê–¶–ò–Ø =====================
        function initMap() {
            if (state.map) return;
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            state.map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                fadeAnimation: true,
                zoomAnimation: true
            }).setView([55.7558, 37.6173], 12);
            
            const customLayer = createCustomTileLayer();
            customLayer.addTo(state.map);
            
            L.control.zoom({
                position: 'bottomright'
            }).addTo(state.map);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            state.map.locate({ 
                setView: false,
                maxZoom: 14,
                watch: false,
                enableHighAccuracy: true 
            });
            
            state.map.on('locationfound', function(e) {
                console.log('Location found:', e.latlng);
                state.currentPosition = e.latlng;
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                if (state.currentMarker) {
                    state.map.removeLayer(state.currentMarker);
                }
                
                state.currentMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'custom-marker marker-customer',
                        html: '<i class="fas fa-user"></i>',
                        iconSize: [60, 60],
                        iconAnchor: [30, 60]
                    })
                }).addTo(state.map)
                .bindPopup('–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ')
                .openPopup();
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
                state.map.setView(e.latlng, 14);
                
                createRippleEffect(e.latlng);
            });
            
            state.map.on('locationerror', function(e) {
                console.error('Location error:', e.message);
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
            });
            
            state.map.on('click', function(e) {
                if (state.role === 'customer') {
                    selectLocation(e.latlng);
                }
            });
            
            setTimeout(() => {
                if (state.map) {
                    state.map.invalidateSize();
                }
            }, 100);
        }

        function createCustomTileLayer() {
            let tileUrl;
            let attribution;
            
            if (state.theme === 'dark') {
                tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                attribution = '¬© OpenStreetMap, ¬© CartoDB';
            } else {
                tileUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                attribution = '¬© OpenStreetMap, ¬© CartoDB';
            }

            return L.tileLayer(tileUrl, {
                attribution: attribution,
                className: 'custom-tile-layer',
                maxZoom: 19,
                minZoom: 3
            });
        }

        function updateMapStyle() {
            state.map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    state.map.removeLayer(layer);
                }
            });
            
            const newLayer = createCustomTileLayer();
            newLayer.addTo(state.map);
        }

        function createPulsingMarker(latlng, title, type) {
            const icon = L.divIcon({
                className: 'custom-marker ' + (type === 'customer' ? 'marker-customer' : 
                              type === 'master' ? 'marker-master' : 'marker-order'),
                html: getMarkerIcon(type),
                iconSize: [60, 60],
                iconAnchor: [30, 60],
                popupAnchor: [0, -60]
            });

            const marker = L.marker(latlng, { icon: icon })
                .addTo(state.map)
                .bindPopup(`<b>${title}</b>`);

            marker.on('mouseover', function() {
                this.setIcon(L.divIcon({
                    className: 'custom-marker ' + (type === 'customer' ? 'marker-customer' : 
                                  type === 'master' ? 'marker-master' : 'marker-order') + ' glow',
                    html: getMarkerIcon(type),
                    iconSize: [70, 70],
                    iconAnchor: [35, 70]
                }));
            });

            marker.on('mouseout', function() {
                this.setIcon(icon);
            });

            return marker;
        }

        function getMarkerIcon(type) {
            const icons = {
                'customer': '<i class="fas fa-user"></i>',
                'master': '<i class="fas fa-tools"></i>',
                'order': '<i class="fas fa-tag"></i>'
            };
            return icons[type] || icons.order;
        }

        function createRippleEffect(latlng) {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ripple = L.circle(latlng, {
                        radius: 10 + (i * 20),
                        color: 'transparent',
                        fillColor: state.theme === 'dark' ? '#4F46E5' : '#818CF8',
                        fillOpacity: 0.3 - (i * 0.1),
                        weight: 0
                    }).addTo(state.map);

                    ripple.setRadius(10 + (i * 20));
                    
                    setTimeout(() => {
                        state.map.removeLayer(ripple);
                    }, 1000);
                }, i * 200);
            }
        }

        function selectLocation(latlng) {
            if (state.selectedMarker) {
                state.map.removeLayer(state.selectedMarker);
            }
            
            state.selectedMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker marker-order',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [40, 40]
                })
            }).addTo(state.map)
            .bindPopup('–ú–µ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞')
            .openPopup();
            
            state.selectedLocation = latlng;
            
            reverseGeocode(latlng.lat, latlng.lng);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                const data = await response.json();
                
                if (data.display_name) {
                    document.getElementById('orderAddress').value = data.display_name;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                document.getElementById('orderAddress').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        window.searchAddress = async function() {
            const query = document.getElementById('addressSearch').value;
            if (!query) return;
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`
                );
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const latlng = [parseFloat(result.lat), parseFloat(result.lon)];
                    
                    state.map.setView(latlng, 16);
                    selectLocation(L.latLng(latlng));
                    
                    showToast("–ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω");
                } else {
                    showToast("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
            } catch (error) {
                showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞");
            }
        };

        window.searchKeyPress = function(e) {
            if (e.key === 'Enter') {
                searchAddress();
            }
        };

        window.centerMap = function() {
            if (state.currentPosition) {
                state.map.setView(state.currentPosition, 14);
            } else {
                state.map.locate({setView: true, maxZoom: 14});
            }
        };

        // ===================== –ó–ê–ö–ê–ó–´ =====================
        async function loadOrders() {
            showSkeletons();
            
            try {
                let query = supabaseClient
                    .from('orders')
                    .select('*');
                
                if (state.role === 'customer' && state.user) {
                    query = query.eq('customer_id', state.user.id);
                } else if (state.role === 'master') {
                    query = query.eq('status', 'new');
                }
                
                const { data: orders, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                state.orders = orders || [];
                console.log('Orders loaded:', state.orders.length);
                updateOrdersList();
                updateMapMarkers();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ' + error.message);
                state.orders = getTestOrders();
                updateOrdersList();
                updateMapMarkers();
            }
        }

        function getTestOrders() {
            return [
                {
                    id: 'test-1',
                    title: "–î–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã",
                    description: "–°—Ä–æ—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞",
                    price: 1500,
                    lat: 55.7558,
                    lng: 37.6173,
                    address: "–ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å",
                    status: "new",
                    customer_id: "test-user-1"
                },
                {
                    id: 'test-2',
                    title: "–ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã",
                    description: "–ú–æ–ª–æ–∫–æ, —Ö–ª–µ–±, —è–π—Ü–∞, —Å—ã—Ä, —Ñ—Ä—É–∫—Ç—ã. –ú–∞–≥–∞–∑–∏–Ω —É –¥–æ–º–∞.",
                    price: 800,
                    lat: 55.7358,
                    lng: 37.6273,
                    address: "–ú–æ—Å–∫–≤–∞, –ê—Ä–±–∞—Ç",
                    status: "new",
                    customer_id: "test-user-2"
                }
            ];
        }

        function showSkeletons() {
            const container = document.getElementById('ordersList');
            container.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'order-card skeleton skeleton-order';
                container.appendChild(skeleton);
            }
        }

        function updateOrdersList() {
            const container = document.getElementById('ordersList');
            const filteredOrders = state.orders.filter(order => 
                state.role === 'customer' || order.status === 'new'
            );
            
            document.getElementById('ordersCount').textContent = filteredOrders.length;
            
            container.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'order-card';
                empty.style.textAlign = 'center';
                empty.style.padding = '40px 20px';
                empty.innerHTML = `
                    <i class="fas fa-inbox" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                    <div style="font-size: 16px; opacity: 0.7;">${state.role === 'customer' ? '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤' : '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤'}</div>
                `;
                container.appendChild(empty);
                return;
            }
            
            filteredOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                container.appendChild(orderCard);
            });
            
            setupSwipeGestures();
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.dataset.orderId = order.id;
            
            const date = new Date(order.created_at || Date.now());
            const dateStr = `${date.getDate()}.${date.getMonth()+1} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            card.innerHTML = `
                <div class="order-header">
                    <div class="order-title">${order.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                    <div class="order-price">${order.price || 0} ‚ÇΩ</div>
                </div>
                <div class="order-meta">
                    <div class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${order.address ? order.address.split(',')[0] : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${dateStr}</span>
                    </div>
                </div>
                <div class="order-description">${order.description || ''}</div>
                <div class="order-actions">
                    <button class="btn btn-primary" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                    ${state.role === 'master' && order.status === 'new' ? `
                    <button class="btn btn-success" onclick="takeOrder('${order.id}')">
                        <i class="fas fa-check"></i> –í–∑—è—Ç—å
                    </button>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        function updateMapMarkers() {
            state.markers.forEach(marker => {
                state.map.removeLayer(marker);
            });
            state.markers.clear();
            
            state.orders.forEach(order => {
                if (order.lat && order.lng) {
                    const latlng = L.latLng(order.lat, order.lng);
                    const marker = createPulsingMarker(
                        latlng,
                        order.title || '–ó–∞–∫–∞–∑',
                        'order'
                    );
                    
                    marker.on('click', () => {
                        viewOrderDetails(order.id);
                    });
                    
                    state.markers.set(order.id, marker);
                }
            });
        }

        // ===================== –°–û–ó–î–ê–ù–ò–ï –ó–ê–ö–ê–ó–ê =====================
        window.openNewOrderModal = function() {
            document.getElementById('newOrderModal').classList.add('active');
            
            document.getElementById('orderTitle').value = '';
            document.getElementById('orderDescription').value = '';
            document.getElementById('orderPrice').value = '';
            document.getElementById('orderAddress').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            state.photos = [];
            
            if (state.selectedMarker) {
                const latlng = state.selectedMarker.getLatLng();
                reverseGeocode(latlng.lat, latlng.lng);
            }
        };

        window.closeNewOrderModal = function() {
            document.getElementById('newOrderModal').classList.remove('active');
        };

        window.handlePhotoUpload = function() {
            const files = document.getElementById('orderPhotos').files;
            const preview = document.getElementById('photoPreview');
            
            for (let file of files) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" class="preview-img">
                        <button class="preview-remove" onclick="removePhoto(this)">√ó</button>
                    `;
                    
                    preview.appendChild(previewItem);
                    
                    state.photos.push({
                        file: file,
                        url: e.target.result
                    });
                };
                
                reader.readAsDataURL(file);
            }
        };

        window.removePhoto = function(button) {
            const previewItem = button.parentElement;
            const index = Array.from(previewItem.parentElement.children).indexOf(previewItem);
            
            state.photos.splice(index, 1);
            previewItem.remove();
        };

        window.createOrder = async function() {
            showLoading();
            
            if (!state.selectedLocation) {
                showToast("–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ");
                hideLoading();
                return;
            }
            
            const title = document.getElementById('orderTitle').value;
            const description = document.getElementById('orderDescription').value;
            const price = parseInt(document.getElementById('orderPrice').value);
            const address = document.getElementById('orderAddress').value;
            
            if (!title || !description || !price || !address) {
                showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                hideLoading();
                return;
            }
            
            if (price < 100) {
                showToast("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ - 100 —Ä—É–±.");
                hideLoading();
                return;
            }
            
            try {
                const { data: order, error } = await supabaseClient
                    .from('orders')
                    .insert([
                        {
                            title,
                            description,
                            price,
                            address,
                            lat: state.selectedLocation.lat,
                            lng: state.selectedLocation.lng,
                            customer_id: state.user.id,
                            status: 'new',
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('Order created:', order);
                state.orders.unshift(order);
                updateOrdersList();
                addOrderMarker(order);
                closeNewOrderModal();
                showToast('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                
            } catch (error) {
                console.error('Error creating order:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message);
            }
            
            hideLoading();
        };

        function addOrderMarker(order) {
            if (order.lat && order.lng) {
                const latlng = L.latLng(order.lat, order.lng);
                const marker = createPulsingMarker(
                    latlng,
                    order.title || '–ó–∞–∫–∞–∑',
                    'order'
                );
                
                marker.on('click', () => {
                    viewOrderDetails(order.id);
                });
                
                state.markers.set(order.id, marker);
            }
        }

        // ===================== –†–ê–ë–û–¢–ê –° –ó–ê–ö–ê–ó–ê–ú–ò =====================
        window.takeOrder = async function(orderId) {
            showLoading();
            
            try {
                const { data: order, error } = await supabaseClient
                    .from('orders')
                    .update({
                        status: 'active',
                        master_id: state.user.id,
                        accepted_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .eq('status', 'new')
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É!');
                await loadOrders();
                closeInfo();
                
            } catch (error) {
                console.error('Error taking order:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message);
            }
            
            hideLoading();
        };

        window.completeOrder = async function(orderId) {
            showLoading();
            
            try {
                const { data: order, error } = await supabaseClient
                    .from('orders')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .eq('master_id', state.user.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!');
                await loadOrders();
                closeInfo();
                
            } catch (error) {
                console.error('Error completing order:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message);
            }
            
            hideLoading();
        };

        window.viewOrderDetails = function(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            
            state.selectedOrder = order;
            
            document.getElementById('infoTitle').textContent = order.title || '–ó–∞–∫–∞–∑';
            
            const content = document.getElementById('infoContent');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 28px; font-weight: bold; color: var(--success); margin-bottom: 10px;">
                        ${order.price || 0} ‚ÇΩ
                    </div>
                    <div style="color: #64748B; margin-bottom: 5px;">
                        <i class="fas fa-map-marker-alt"></i> ${order.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}
                    </div>
                    <div style="color: #64748B;">
                        <i class="fas fa-clock"></i> ${new Date(order.created_at || Date.now()).toLocaleString()}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">–û–ø–∏—Å–∞–Ω–∏–µ:</div>
                    <div>${order.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                </div>
                
                ${state.role === 'customer' ? `
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">–°—Ç–∞—Ç—É—Å:</div>
                    <div class="status-badge ${order.status === 'new' ? 'status-new' : order.status === 'active' ? 'status-active' : 'status-completed'}">
                        ${order.status === 'new' ? '–ù–æ–≤—ã–π' : order.status === 'active' ? '–í —Ä–∞–±–æ—Ç–µ' : '–ó–∞–≤–µ—Ä—à–µ–Ω'}
                    </div>
                </div>
                ` : ''}
            `;
            
            const actions = document.getElementById('infoActions');
            actions.innerHTML = '';
            
            if (state.role === 'master' && order.status === 'new') {
                actions.innerHTML = `
                    <button class="btn btn-outline" onclick="closeInfo()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-success" onclick="takeOrder('${order.id}')">
                        <i class="fas fa-check"></i> –í–∑—è—Ç—å –∑–∞–∫–∞–∑
                    </button>
                `;
            } else if (state.role === 'master' && order.status === 'active' && order.master_id === state.user.id) {
                actions.innerHTML = `
                    <button class="btn btn-outline" onclick="openChat('${order.id}')">
                        <i class="fas fa-comments"></i> –ß–∞—Ç
                    </button>
                    <button class="btn btn-success" onclick="completeOrder('${order.id}')">
                        <i class="fas fa-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                `;
            } else if (state.role === 'customer' && (order.status === 'active' || order.status === 'new')) {
                actions.innerHTML = `
                    <button class="btn btn-outline" onclick="openChat('${order.id}')">
                        <i class="fas fa-comments"></i> –ß–∞—Ç
                    </button>
                    <button class="btn btn-primary" onclick="closeInfo()">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-primary" onclick="closeInfo()" style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
            }
            
            document.getElementById('mapInfo').style.display = 'block';
            
            if (order.lat && order.lng) {
                state.map.setView([order.lat, order.lng], 16);
            }
        };

        window.closeInfo = function() {
            document.getElementById('mapInfo').style.display = 'none';
            state.selectedOrder = null;
        };

        // ===================== –ß–ê–¢ =====================
        window.openChat = function(orderId) {
            state.activeChatOrderId = orderId;
            document.getElementById('chatModal').classList.add('active');
            document.getElementById('chatTitle').textContent = `–ß–∞—Ç –∑–∞–∫–∞–∑–∞ #${orderId.substring(0, 8)}`;
            loadChatMessages(orderId);
        };

        async function loadChatMessages(orderId) {
            try {
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .eq('order_id', orderId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                displayChatMessages(messages || []);
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function displayChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender_id === state.user.id ? 'outgoing' : 'incoming'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${message.sender_id === state.user.id ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'}</div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-time">${new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        window.sendChatMessage = async function() {
            if (!state.activeChatOrderId) {
                console.error('No active chat order id');
                showToast('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .insert([
                        {
                            order_id: state.activeChatOrderId,
                            sender_id: state.user.id,
                            message: message,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (error) {
                    console.error('Error sending message:', error);
                    throw error;
                }
                
                input.value = '';
                await loadChatMessages(state.activeChatOrderId);
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            }
        };

        window.chatKeyPress = function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        };

        window.closeChat = function() {
            document.getElementById('chatModal').classList.remove('active');
            state.activeChatOrderId = null;
        };

        // ===================== REALTIME –ü–û–î–ü–ò–°–ö–ò =====================
        function setupRealtimeSubscriptions() {
            state.subscriptions.forEach(sub => sub.unsubscribe());
            state.subscriptions = [];
            
            if (state.role === 'master') {
                const ordersSubscription = supabaseClient
                    .channel('orders-channel')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'orders' },
                        async (payload) => {
                            console.log('New order:', payload.new);
                            const { data: order, error } = await supabaseClient
                                .from('orders')
                                .select('*')
                                .eq('id', payload.new.id)
                                .single();
                            
                            if (!error && order && order.status === 'new') {
                                state.orders.unshift(order);
                                updateOrdersList();
                                addOrderMarker(order);
                                playNotificationSound();
                                showToast('–ü–æ—è–≤–∏–ª—Å—è –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑!');
                            }
                        }
                    )
                    .subscribe();
                
                state.subscriptions.push(ordersSubscription);
            }
            
            const ordersUpdateSubscription = supabaseClient
                .channel('orders-update-channel')
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'orders' },
                    async (payload) => {
                        const orderIndex = state.orders.findIndex(o => o.id === payload.new.id);
                        
                        if (orderIndex !== -1) {
                            const { data: order, error } = await supabaseClient
                                .from('orders')
                                .select('*')
                                .eq('id', payload.new.id)
                                .single();
                            
                            if (!error && order) {
                                state.orders[orderIndex] = order;
                                updateOrdersList();
                                
                                if (payload.new.status === 'active' && 
                                    payload.new.master_id === state.user.id) {
                                    showToast('–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑ –≤ —Ä–∞–±–æ—Ç—É!');
                                }
                            }
                        }
                    }
                )
                .subscribe();
            
            state.subscriptions.push(ordersUpdateSubscription);
            
            const messagesSubscription = supabaseClient
                .channel('messages-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' },
                    async (payload) => {
                        if (state.activeChatOrderId === payload.new.order_id) {
                            await loadChatMessages(state.activeChatOrderId);
                            playNotificationSound();
                        }
                    }
                )
                .subscribe();
            
            state.subscriptions.push(messagesSubscription);
        }

        // ===================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====================
        window.toggleSidePanel = function() {
            const panel = document.getElementById('sidePanel');
            const icon = document.getElementById('panelToggleIcon');
            
            state.sidePanelOpen = !state.sidePanelOpen;
            panel.classList.toggle('hidden');
            
            icon.className = state.sidePanelOpen ? 
                'fas fa-chevron-left' : 'fas fa-chevron-right';
        };

        window.switchRole = function(role) {
            state.role = role;
            
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('userRole').textContent = 
                role === 'customer' ? '–ó–∞–∫–∞–∑—á–∏–∫' : '–ú–∞—Å—Ç–µ—Ä';
            document.getElementById('titleText').textContent = 
                role === 'customer' ? '–ú–æ–∏ –∑–∞–∫–∞–∑—ã' : '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã';
            
            loadOrders();
        };

        window.toggleTheme = function() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('microhelp_theme', state.theme);
            loadTheme();
            if (state.map) {
                updateMapStyle();
            }
        };

        function loadTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            const icon = state.theme === 'light' ? 'fa-moon' : 'fa-sun';
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = `fas ${icon}`;
            }
        };

        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed:", e));
                }
            } catch (e) {
                console.log("Audio error:", e);
            }
        };

        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        };

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        };

        function showToast(message) {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: state.theme === 'dark' ? 
                    "linear-gradient(to right, #4F46E5, #4338CA)" :
                    "linear-gradient(to right, #6366F1, #8B5CF6)",
                stopOnFocus: true
            }).showToast();
        };

        function setupEventListeners() {
            setTimeout(() => {
                document.querySelectorAll('.order-card').forEach((card, i) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        card.offsetHeight;
                        card.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, i * 100);
                });
            }, 300);
        };

        function setupSwipeGestures() {
            document.querySelectorAll('.order-card').forEach(card => {
                let startX = 0;
                let currentX = 0;
                
                card.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, { passive: true });
                
                card.addEventListener('touchmove', (e) => {
                    currentX = e.touches[0].clientX - startX;
                    card.style.transform = `translateX(${currentX}px)`;
                }, { passive: true });
                
                card.addEventListener('touchend', () => {
                    if (Math.abs(currentX) > 100) {
                        const orderId = card.dataset.orderId;
                        if (currentX > 0 && state.role === 'master') {
                            takeOrder(orderId);
                        } else if (currentX < 0) {
                            viewOrderDetails(orderId);
                        }
                    }
                    card.style.transform = 'translateX(0)';
                });
            });
        };
    </script>
</body>
</html>
