<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroHelp Real-Time</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; --card: #FFFFFF; --text: #1C1C1E; --green: #34C759; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; padding-bottom: 20px; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #EEE; }
        .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; font-size: 14px; margin-top: 10px; transition: 0.2s; }
        .btn-main { background: var(--p); color: white; }
        .btn-ghost { background: #E5E5EA; color: var(--text); }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #DDD; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
        
        /* –ß–∞—Ç */
        #chat-view { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; }
        .chat-header { padding: 20px; border-bottom: 1px solid #EEE; font-weight: 800; display: flex; align-items: center; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #F8F9FB; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 14px; }
        .msg.sent { align-self: flex-end; background: var(--p); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: #E5E5EA; border-bottom-left-radius: 4px; }
        
        .screen { display: none; }
        .active { display: block; }
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; float: right; }
        .status-searching { background: #E5F1FF; color: var(--p); }
        .status-active { background: #FFF4E5; color: orange; }
    </style>
</head>
<body>

<div id="screen-auth" class="screen active">
    <div class="container" style="text-align: center; margin-top: 100px;">
        <h1 style="font-weight: 900; color: var(--p);">MicroHelp</h1>
        <button class="btn btn-main" onclick="selectRole('client')">üôã‚Äç‚ôÇÔ∏è –Ø –ó–∞–∫–∞–∑—á–∏–∫</button>
        <button class="btn btn-ghost" onclick="selectRole('worker')">üõ† –Ø –ü–æ–º–æ—â–Ω–∏–∫</button>
        <p style="font-size: 12px; opacity: 0.5; margin-top: 20px;">–†–µ–∂–∏–º Real-Time –≤–∫–ª—é—á–µ–Ω</p>
    </div>
</div>

<div id="screen-app" class="screen">
    <header style="background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
        <b id="user-display">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
        <button onclick="location.reload()" style="background:none; border:none; color:var(--p)">–í—ã–π—Ç–∏</button>
    </header>

    <div class="container">
        <div id="ui-client" style="display:none">
            <div class="card">
                <h3>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                <input id="t-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
                <input id="t-price" type="number" placeholder="–ë—é–¥–∂–µ—Ç (‚ÇΩ)">
                <button class="btn btn-main" onclick="createTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <h4>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h4>
            <div id="client-list"></div>
        </div>

        <div id="ui-worker" style="display:none">
            <h3>–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</h3>
            <div id="worker-feed"></div>
        </div>
    </div>
</div>

<div id="chat-view">
    <div class="chat-header">
        <span onclick="closeChat()" style="cursor:pointer; margin-right: 15px;">‚Üê</span>
        <span id="chat-title">–ß–∞—Ç</span>
    </div>
    <div class="chat-messages" id="chat-msgs"></div>
    <div style="padding: 15px; display: flex; gap: 10px; background: white;">
        <input id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
        <button class="btn btn-main" style="width: auto; margin:0" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í—Å—Ç–∞–≤—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ!)
    const firebaseConfig = {
        apiKey: "AIzaSyBgNLqexeJE0hPOcW2EExSnL4QHMX6hVvI",
        authDomain: "microhelp-953ca.firebaseapp.com",
        projectId: "microhelp-953ca",
        storageBucket: "microhelp-953ca.firebasestorage.app",
        messagingSenderId: "966336795289",
        appId: "1:966336795289:web:c5563125d06af5b0dcde08"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let userRole = '';
    let userId = 'user_' + Math.floor(Math.random() * 10000);
    let activeChatId = null;
    let firstLoad = true;

    // 2. –ó–í–£–ö–û–í–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (Web Audio API)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if(type === 'new_task') { // –í—ã—Å–æ–∫–∏–π –¥–≤–æ–π–Ω–æ–π –ø–∏–∫
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.2);
        } else { // –ú—è–≥–∫–∏–π –∑–≤—É–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
        }
        
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.2);
    }

    // 3. –õ–û–ì–ò–ö–ê –û–ù–õ–ê–ô–ù –û–ë–ù–û–í–õ–ï–ù–ò–Ø
    function selectRole(role) {
        userRole = role;
        document.getElementById('screen-auth').classList.remove('active');
        document.getElementById('screen-app').classList.add('active');
        document.getElementById('user-display').innerText = role === 'client' ? 'üôã‚Äç‚ôÇÔ∏è –ó–∞–∫–∞–∑—á–∏–∫' : 'üõ† –ü–æ–º–æ—â–Ω–∏–∫';
        document.getElementById(role === 'client' ? 'ui-client' : 'ui-worker').style.display = 'block';
        
        startListening();
    }

    function startListening() {
        // –°–ª—É—à–∞–µ–º –í–°–ï –∑–∞–∫–∞–∑—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        db.collection("tasks").orderBy("createdAt", "desc").onSnapshot(snapshot => {
            const cList = document.getElementById('client-list');
            const wFeed = document.getElementById('worker-feed');
            
            // –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª—Å—è –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî –∏–≥—Ä–∞–µ–º –∑–≤—É–∫
            if (!firstLoad && snapshot.docChanges().some(change => change.type === "added")) {
                if (userRole === 'worker') playSound('new_task');
            }
            firstLoad = false;

            cList.innerHTML = '';
            wFeed.innerHTML = '';

            snapshot.forEach(doc => {
                const t = doc.data();
                const id = doc.id;
                const card = `
                    <div class="card">
                        <span class="status-badge status-${t.status}">${t.status}</span>
                        <b>${t.title}</b><br>${t.price} ‚ÇΩ
                        ${userRole === 'client' && t.status === 'searching' ? `<button class="btn btn-main" onclick="takeOrder('${id}')">–ü—Ä–∏–Ω—è—Ç—å –æ—Ç–∫–ª–∏–∫</button>` : ''}
                        ${userRole === 'worker' && t.status === 'searching' ? `<button class="btn btn-main" onclick="apply('${id}')">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>` : ''}
                        ${t.status === 'active' ? `<button class="btn btn-ghost" onclick="openChat('${id}')">–û—Ç–∫—Ä—ã—Ç—å –ß–∞—Ç</button>` : ''}
                    </div>`;

                if (t.clientId === userId) cList.innerHTML += card;
                if (t.status === 'searching') wFeed.innerHTML += card;
                else if (t.workerId === userId || t.clientId === userId) {
                    if(userRole === 'worker') wFeed.innerHTML += card;
                }
            });
        });
    }

    async function createTask() {
        const title = document.getElementById('t-title').value;
        const price = document.getElementById('t-price').value;
        await db.collection("tasks").add({
            title, price, status: 'searching', clientId: userId, createdAt: Date.now(), messages: []
        });
        document.getElementById('t-title').value = '';
    }

    async function apply(id) {
        await db.collection("tasks").doc(id).update({ status: 'active', workerId: userId });
        playSound('msg');
    }

    // 4. –û–ù–õ–ê–ô–ù –ß–ê–¢
    function openChat(id) {
        activeChatId = id;
        document.getElementById('chat-view').style.display = 'flex';
        
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –∑–∞–∫–∞–∑–µ
        db.collection("tasks").doc(id).onSnapshot(doc => {
            const data = doc.data();
            const box = document.getElementById('chat-msgs');
            const oldMsgCount = box.children.length;
            
            box.innerHTML = (data.messages || []).map(m => `
                <div class="msg ${m.sender === userId ? 'sent' : 'received'}">${m.text}</div>
            `).join('');
            
            box.scrollTop = box.scrollHeight;

            // –ó–≤—É–∫ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –∏—Ö —Å—Ç–∞–ª–æ –±–æ–ª—å—à–µ
            if (data.messages && data.messages.length > oldMsgCount) {
                if (data.messages[data.messages.length-1].sender !== userId) playSound('msg');
            }
        });
    }

    async function sendMsg() {
        const text = document.getElementById('chat-in').value;
        if (!text) return;
        const ref = db.collection("tasks").doc(activeChatId);
        const doc = await ref.get();
        const msgs = doc.data().messages || [];
        msgs.push({ text, sender: userId, time: Date.now() });
        await ref.update({ messages: msgs });
        document.getElementById('chat-in').value = '';
    }

    function closeChat() { document.getElementById('chat-view').style.display = 'none'; }
</script>
</body>
</html>
