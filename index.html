<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroHelp - Заказы микро-помощи</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (полный CSS стиль остается без изменений) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #818CF8;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-light: #FFFFFF;
            --bg-dark: #0F172A;
            --map-bg-light: #F8FAFC;
            --map-bg-dark: #1E293B;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --text-color: #1E293B;
            --map-bg: var(--map-bg-light);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --text-color: #F1F5F9;
            --map-bg: var(--map-bg-dark);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* ... (полный CSS стиль остается без изменений) ... */
    </style>
</head>
<body>
    <!-- Модалка аутентификации -->
    <div class="auth-modal active" id="authModal">
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Вход</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Регистрация</button>
            </div>
            
            <!-- Форма входа -->
            <div class="auth-form active" id="loginForm">
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email" autocomplete="email">
                <input type="password" class="auth-input" id="loginPassword" placeholder="Пароль" autocomplete="current-password">
                <button class="auth-btn" onclick="login()">Войти</button>
                <div class="auth-footer">
                    Нет аккаунта? <span class="auth-switch" onclick="switchAuthTab('register')">Зарегистрируйтесь</span>
                </div>
            </div>
            
            <!-- Форма регистрации -->
            <div class="auth-form" id="registerForm">
                <div class="role-selector">
                    <div class="role-option active" onclick="selectRole('customer')">
                        <i class="fas fa-shopping-cart"></i>
                        <div>Заказчик</div>
                    </div>
                    <div class="role-option" onclick="selectRole('master')">
                        <i class="fas fa-tools"></i>
                        <div>Мастер</div>
                    </div>
                </div>
                <input type="text" class="auth-input" id="registerName" placeholder="Имя">
                <input type="email" class="auth-input" id="registerEmail" placeholder="Email">
                <input type="password" class="auth-input" id="registerPassword" placeholder="Пароль (минимум 6 символов)">
                <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="Подтвердите пароль">
                <button class="auth-btn" onclick="register()">Зарегистрироваться</button>
                <div class="auth-footer">
                    Уже есть аккаунт? <span class="auth-switch" onclick="switchAuthTab('login')">Войдите</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Анимированный фон -->
    <div class="animated-bg"></div>
    
    <!-- Основной интерфейс -->
    <div class="app-container" id="mainInterface" style="display: none;">
        <!-- Боковая панель -->
        <div class="side-panel" id="sidePanel">
            <button class="panel-toggle" onclick="toggleSidePanel()">
                <i class="fas fa-chevron-left" id="panelToggleIcon"></i>
            </button>
            
            <div class="panel-header">
                <div class="app-logo">
                    <div class="logo-icon">
                        <i class="fas fa-hands-helping"></i>
                    </div>
                    <div class="logo-text">MicroHelp</div>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div style="font-weight: 600;" id="userName">Гость</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="userRole">Заказчик</div>
                    </div>
                    <button class="logout-btn" onclick="logout()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: auto;" title="Выйти">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Переключатель ролей -->
            <div class="role-switcher">
                <button class="role-btn active" onclick="switchRole('customer')">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Заказчик</span>
                </button>
                <button class="role-btn" onclick="switchRole('master')">
                    <i class="fas fa-tools"></i>
                    <span>Мастер</span>
                </button>
            </div>
            
            <!-- Контент панели -->
            <div class="panel-content">
                <h2 class="section-title" id="panelTitle">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="titleText">Доступные заказы</span>
                    <span style="margin-left: auto; font-size: 14px; color: var(--primary);" id="ordersCount">0</span>
                </h2>
                
                <div id="ordersList" class="orders-grid">
                    <!-- Заказы загружаются здесь -->
                </div>
            </div>
        </div>
        
        <!-- Основная карта -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Поиск -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="addressSearch" 
                           placeholder="Поиск адреса или места..."
                           onkeypress="searchKeyPress(event)">
                    <button class="search-btn" onclick="searchAddress()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Элементы управления картой -->
            <div class="map-controls">
                <button class="map-control-btn" onclick="centerMap()" title="Мое местоположение">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="map-control-btn pulse" onclick="openNewOrderModal()" id="newOrderBtn" title="Создать заказ">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="map-control-btn" onclick="toggleTheme()" title="Сменить тему">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="map-control-btn" onclick="openProfileModal()" title="Профиль">
                    <i class="fas fa-user-cog"></i>
                </button>
            </div>
            
            <!-- Информационное окно на карте -->
            <div class="map-info" id="mapInfo">
                <div class="info-header">
                    <div class="info-title" id="infoTitle"></div>
                    <button class="info-close" onclick="closeInfo()">×</button>
                </div>
                <div id="infoContent"></div>
                <div class="order-actions" id="infoActions" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания заказа -->
    <div class="order-modal" id="newOrderModal">
        <div class="order-modal-content">
            <button class="modal-close" onclick="closeNewOrderModal()">×</button>
            <h2 class="modal-title">Новый заказ</h2>
            
            <div class="form-group">
                <label class="form-label">Название задачи</label>
                <input type="text" id="orderTitle" class="form-control" placeholder="Что нужно сделать?">
            </div>
            
            <div class="form-group">
                <label class="form-label">Описание</label>
                <textarea id="orderDescription" class="form-control" placeholder="Подробно опишите задачу..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Стоимость (руб.)</label>
                <input type="number" id="orderPrice" class="form-control" placeholder="500" min="100" step="100">
            </div>
            
            <div class="form-group">
                <label class="form-label">Адрес</label>
                <input type="text" id="orderAddress" class="form-control" placeholder="Выберите точку на карте или введите адрес">
            </div>
            
            <div class="form-group">
                <label class="form-label">Фотографии (необязательно)</label>
                <div class="photo-upload" onclick="document.getElementById('orderPhotos').click()">
                    <i class="fas fa-camera"></i>
                    <div>Нажмите для загрузки фотографий</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Можно загрузить несколько файлов</div>
                </div>
                <input type="file" id="orderPhotos" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload()">
                <div class="photo-preview" id="photoPreview"></div>
            </div>
            
            <div class="order-actions">
                <button class="btn btn-outline" onclick="closeNewOrderModal()">Отмена</button>
                <button class="btn btn-primary" onclick="createOrder()">Создать заказ</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно профиля -->
    <div class="order-modal" id="profileModal">
        <div class="order-modal-content">
            <button class="modal-close" onclick="closeProfileModal()">×</button>
            <h2 class="modal-title">Мой профиль</h2>
            
            <div class="form-group">
                <label class="form-label">Имя</label>
                <input type="text" id="profileName" class="form-control" placeholder="Ваше имя">
            </div>
            
            <div class="form-group">
                <label class="form-label">Телефон</label>
                <input type="tel" id="profilePhone" class="form-control" placeholder="+7 (999) 123-45-67">
            </div>
            
            <div class="form-group">
                <label class="form-label">Описание</label>
                <textarea id="profileDescription" class="form-control" placeholder="Расскажите о себе..."></textarea>
            </div>
            
            <div class="order-actions">
                <button class="btn btn-outline" onclick="closeProfileModal()">Отмена</button>
                <button class="btn btn-primary" onclick="saveProfile()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно чата -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-container">
            <div class="chat-header">
                <h3 id="chatTitle">Чат заказа</h3>
                <button onclick="closeChat()" style="background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer;">×</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Введите сообщение..." onkeypress="chatKeyPress(event)">
                <button class="btn btn-primary" onclick="sendChatMessage()">Отправить</button>
            </div>
        </div>
    </div>

    <!-- Скрытые элементы -->
    <input type="file" id="chatPhotoInput" accept="image/*" style="display: none;">
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <!-- Подключение библиотек -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // --- НАСТРОЙКИ (Вставьте свои данные здесь) ---
        const SUPABASE_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yaG92bWFieWF3YmZ6Y3h3bWliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NDEzNjAsImV4cCI6MjA4NDExNzM2MH0.lagPVLLopst3yx5eiuJchwOP4wJg49cEqmWZrNWxFrQ';
        
        // Инициализация Supabase клиента
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===================== СОСТОЯНИЕ ПРИЛОЖЕНИЯ =====================
        const state = {
            user: null,
            role: 'customer',
            map: null,
            currentPosition: null,
            markers: new Map(),
            selectedOrder: null,
            orders: [],
            sidePanelOpen: true,
            theme: localStorage.getItem('microhelp_theme') || 'light',
            authTab: 'login',
            selectedRegisterRole: 'customer',
            subscriptions: [],
            selectedLocation: null,
            selectedMarker: null,
            photos: [],
            activeChatOrderId: null
        };

        // ===================== СДЕЛАЕМ ФУНКЦИИ ДОСТУПНЫМИ ДЛЯ HTML (ОТКРЫВАЕМ ИХ) =====================
        
        // Переключение вкладок Вход / Регистрация
        window.switchAuthTab = function(tab) {
            state.authTab = tab;
            
            // Обновляем активные вкладки
            const tabs = document.querySelectorAll('.auth-tab');
            const forms = document.querySelectorAll('.auth-form');
            
            tabs.forEach(t => t.classList.remove('active'));
            forms.forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        };

        // Выбор роли (Заказчик / Мастер)
        window.selectRole = function(role) {
            state.selectedRegisterRole = role;
            const options = document.querySelectorAll('.role-option');
            options.forEach(opt => opt.classList.remove('active'));
            
            if (role === 'customer') {
                options[0].classList.add('active');
            } else {
                options[1].classList.add('active');
            }
        };

        // Функция входа
        window.login = async function() {
            showLoading();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showToast('Заполните все поля', 'danger');
                hideLoading();
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                state.user = data.user;
                await loadUserProfile();
                hideAuthModal();
                showMainInterface();
                initMap();
                loadOrders();
                setupRealtimeSubscriptions();
                showToast('Вход выполнен успешно!', 'success');
                
            } catch (err) {
                console.error('Login error:', err);
                showToast(err.message || 'Ошибка входа', 'danger');
            }
            
            hideLoading();
        };

        // Функция регистрации
        window.register = async function() {
            showLoading();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (!name || !email || !password || !confirmPassword) {
                showToast('Заполните все поля', 'danger');
                hideLoading();
                return;
            }
            
            if (password.length < 6) {
                showToast('Пароль должен быть минимум 6 символов', 'danger');
                hideLoading();
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Пароли не совпадают', 'danger');
                hideLoading();
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { 
                            name: name, 
                            role: state.selectedRegisterRole 
                        }
                    }
                });

                if (error) throw error;
                
                showToast('Регистрация успешна! Проверьте вашу почту для подтверждения', 'success');
                switchAuthTab('login');
                
            } catch (err) {
                console.error('Registration error:', err);
                showToast(err.message || 'Ошибка регистрации', 'danger');
            }
            
            hideLoading();
        };

        // Проверка, залогинен ли пользователь
        async function checkUserStatus() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                state.user = user;
                await loadUserProfile();
                hideAuthModal();
                showMainInterface();
                initMap();
                loadOrders();
                setupRealtimeSubscriptions();
            } else {
                showAuthModal();
                initMap(); // Инициализируем карту, но без данных пользователя
            }
        }

        // Инициализация приложения после входа
        function initApp() {
            loadTheme();
            
            // Инициализируем карту если ее еще нет
            if (!state.map) {
                initMap();
            }
        }

        // ===================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====================
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function showMainInterface() {
            document.getElementById('mainInterface').style.display = 'flex';
        }

        function showToast(text, type) {
            Toastify({
                text: text,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { 
                    background: type === "danger" ? "#EF4444" : "#10B981",
                    borderRadius: "8px",
                    padding: "10px 15px"
                }
            }).showToast();
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ===================== ОСТАЛЬНЫЕ ФУНКЦИИ ПРИЛОЖЕНИЯ =====================

        // Инициализация карты
        function initMap() {
            if (state.map) return;
            
            // Создаем карту
            state.map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                fadeAnimation: true,
                zoomAnimation: true
            }).setView([55.7558, 37.6173], 12);
            
            // Добавляем кастомный слой карты
            const customLayer = createCustomTileLayer();
            customLayer.addTo(state.map);
            
            // Добавляем кастомные элементы управления
            L.control.zoom({
                position: 'bottomright'
            }).addTo(state.map);
            
            // Определяем местоположение
            state.map.locate({setView: true, maxZoom: 14});
            
            state.map.on('locationfound', function(e) {
                state.currentPosition = e.latlng;
                
                // Создаем уникальный маркер для местоположения
                createPulsingMarker(e.latlng, 'Ваше местоположение', 'customer');
                
                // Добавляем анимацию
                createRippleEffect(e.latlng);
            });
            
            state.map.on('click', function(e) {
                if (state.role === 'customer') {
                    selectLocation(e.latlng);
                }
            });
            
            // Исправляем отображение карты
            setTimeout(() => {
                if (state.map) {
                    state.map.invalidateSize();
                }
            }, 100);
        }

        function createCustomTileLayer() {
            // Используем разные провайдеры для уникального вида
            let tileUrl;
            let attribution;
            
            if (state.theme === 'dark') {
                // Темная тема с уникальным стилем
                tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                attribution = '© OpenStreetMap, © CartoDB';
            } else {
                // Светлая тема с пастельными цветами
                tileUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                attribution = '© OpenStreetMap, © CartoDB';
            }

            return L.tileLayer(tileUrl, {
                attribution: attribution,
                className: 'custom-tile-layer',
                maxZoom: 19,
                minZoom: 3
            });
        }

        // ===================== ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ =====================
        async function loadUserProfile() {
            if (!state.user) return;
            
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', state.user.id)
                .single();
            
            if (!error && profile) {
                state.role = profile.role || 'customer';
                updateUserInterface(profile);
            }
        }

        function updateUserInterface(profile) {
            if (!state.user) return;
            
            // Обновляем информацию в интерфейсе
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            const name = profile?.name || state.user.user_metadata?.name || state.user.email?.split('@')[0] || 'Пользователь';
            const role = state.role === 'customer' ? 'Заказчик' : 'Мастер';
            
            if (userAvatar) userAvatar.textContent = name.charAt(0).toUpperCase();
            if (userName) userName.textContent = name;
            if (userRole) userRole.textContent = role;
            
            // Обновляем заголовок в зависимости от роли
            const titleText = document.getElementById('titleText');
            if (titleText) {
                titleText.textContent = state.role === 'customer' ? 'Мои заказы' : 'Доступные заказы';
            }
            
            // Показываем/скрываем кнопку создания заказа
            const newOrderBtn = document.getElementById('newOrderBtn');
            if (newOrderBtn) {
                newOrderBtn.style.display = state.role === 'customer' ? 'block' : 'none';
            }
        }

        function openProfileModal() {
            loadProfileData();
            document.getElementById('profileModal').classList.add('active');
        }

        async function loadProfileData() {
            if (!state.user) return;
            
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', state.user.id)
                    .single();
                
                if (!error && profile) {
                    document.getElementById('profileName').value = profile.name || '';
                    document.getElementById('profilePhone').value = profile.phone || '';
                    document.getElementById('profileDescription').value = profile.description || '';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function saveProfile() {
            showLoading();
            
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const description = document.getElementById('profileDescription').value.trim();
            
            if (!name) {
                showToast('Имя обязательно для заполнения', 'danger');
                hideLoading();
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        name: name,
                        phone: phone,
                        description: description,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', state.user.id);
                
                if (error) throw error;
                
                showToast('Профиль обновлен', 'success');
                closeProfileModal();
                await loadUserProfile();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Ошибка обновления профиля', 'danger');
            }
            
            hideLoading();
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        // ===================== ЗАКАЗЫ =====================
        async function loadOrders() {
            showSkeletons();
            
            try {
                let query = supabase
                    .from('orders')
                    .select(`
                        *,
                        customer:profiles!orders_customer_id_fkey(name, rating),
                        master:profiles!orders_master_id_fkey(name, rating)
                    `);
                
                if (state.role === 'customer') {
                    // Заказчик видит только свои заказы
                    query = query.eq('customer_id', state.user.id);
                } else {
                    // Мастер видит все доступные заказы
                    query = query.eq('status', 'new');
                }
                
                const { data: orders, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                state.orders = orders || [];
                updateOrdersList();
                updateMapMarkers();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Ошибка загрузки заказов', 'danger');
                state.orders = getTestOrders();
                updateOrdersList();
                updateMapMarkers();
            }
        }

        function getTestOrders() {
            return [
                {
                    id: 'test-1',
                    title: "Доставить документы",
                    description: "Срочная доставка документов в центр города",
                    price: 1500,
                    location: { lat: 55.7558, lng: 37.6173 },
                    address: "Москва, Красная площадь",
                    status: "new",
                    customer: { name: "Иван Иванов" },
                    created_at: new Date().toISOString()
                },
                {
                    id: 'test-2',
                    title: "Купить продукты",
                    description: "Молоко, хлеб, яйца, сыр, фрукты. Магазин у дома.",
                    price: 800,
                    location: { lat: 55.7358, lng: 37.6273 },
                    address: "Москва, Арбат",
                    status: "new",
                    customer: { name: "Алексей Петров" },
                    created_at: new Date().toISOString()
                }
            ];
        }

        function showSkeletons() {
            const container = document.getElementById('ordersList');
            container.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'order-card skeleton skeleton-order';
                container.appendChild(skeleton);
            }
        }

        function updateOrdersList() {
            const container = document.getElementById('ordersList');
            const filteredOrders = state.orders.filter(order => 
                state.role === 'customer' || order.status === 'new'
            );
            
            document.getElementById('ordersCount').textContent = filteredOrders.length;
            
            container.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'order-card';
                empty.style.textAlign = 'center';
                empty.style.padding = '40px 20px';
                empty.innerHTML = `
                    <i class="fas fa-inbox" style="font-size: 40px; opacity: 0.5; margin-bottom: 15px;"></i>
                    <div style="font-size: 16px; opacity: 0.7;">${state.role === 'customer' ? 'У вас пока нет заказов' : 'Нет доступных заказов'}</div>
                `;
                container.appendChild(empty);
                return;
            }
            
            filteredOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                container.appendChild(orderCard);
            });
            
            setupSwipeGestures();
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.dataset.orderId = order.id;
            
            // Определяем статус
            let statusText = '';
            switch(order.status) {
                case 'new':
                    statusText = 'Новый';
                    break;
                case 'active':
                    statusText = 'В работе';
                    break;
                case 'completed':
                    statusText = 'Завершен';
                    break;
            }
            
            // Форматируем дату
            const date = new Date(order.created_at);
            const dateStr = `${date.getDate()}.${date.getMonth()+1} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            card.innerHTML = `
                <div class="order-header">
                    <div class="order-title">${order.title}</div>
                    <div class="order-price">${order.price} ₽</div>
                </div>
                <div class="order-meta">
                    <div class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${order.address ? order.address.split(',')[0] : 'Не указан'}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${dateStr}</span>
                    </div>
                </div>
                <div class="order-description">${order.description}</div>
                <div class="order-actions">
                    <button class="btn btn-primary" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-info-circle"></i> Подробнее
                    </button>
                    ${state.role === 'master' && order.status === 'new' ? `
                    <button class="btn btn-success" onclick="takeOrder('${order.id}')">
                        <i class="fas fa-check"></i> Взять
                    </button>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        // ===================== КАРТА И ГЕОЛОКАЦИЯ =====================
        function createPulsingMarker(latlng, title, type) {
            // Создаем пульсирующий маркер
            const icon = L.divIcon({
                className: 'custom-marker ' + (type === 'customer' ? 'marker-customer' : 
                              type === 'master' ? 'marker-master' : 'marker-order'),
                html: getMarkerIcon(type),
                iconSize: [60, 60],
                iconAnchor: [30, 60],
                popupAnchor: [0, -60]
            });

            const marker = L.marker(latlng, { icon: icon })
                .addTo(state.map)
                .bindPopup(`<b>${title}</b>`);

            // Добавляем эффект при наведении
            marker.on('mouseover', function() {
                this.setIcon(L.divIcon({
                    className: 'custom-marker ' + (type === 'customer' ? 'marker-customer' : 
                                  type === 'master' ? 'marker-master' : 'marker-order') + ' glow',
                    html: getMarkerIcon(type),
                    iconSize: [70, 70],
                    iconAnchor: [35, 70]
                }));
            });

            marker.on('mouseout', function() {
                this.setIcon(icon);
            });

            return marker;
        }

        function getMarkerIcon(type) {
            const icons = {
                'customer': '<i class="fas fa-user"></i>',
                'master': '<i class="fas fa-tools"></i>',
                'order': '<i class="fas fa-tag"></i>'
            };
            return icons[type] || icons.order;
        }

        function createRippleEffect(latlng) {
            // Создаем эффект волн при клике
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ripple = L.circle(latlng, {
                        radius: 10 + (i * 20),
                        color: 'transparent',
                        fillColor: state.theme === 'dark' ? '#4F46E5' : '#818CF8',
                        fillOpacity: 0.3 - (i * 0.1),
                        weight: 0
                    }).addTo(state.map);

                    ripple.setRadius(10 + (i * 20));
                    
                    setTimeout(() => {
                        state.map.removeLayer(ripple);
                    }, 1000);
                }, i * 200);
            }
        }

        function selectLocation(latlng) {
            // Удаляем предыдущий маркер выбора
            if (state.selectedMarker) {
                state.map.removeLayer(state.selectedMarker);
            }
            
            // Добавляем новый маркер
            state.selectedMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker marker-order',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [40, 40]
                })
            }).addTo(state.map)
            .bindPopup('Место выполнения заказа')
            .openPopup();
            
            state.selectedLocation = latlng;
            
            // Получаем адрес по координатам
            reverseGeocode(latlng.lat, latlng.lng);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                const data = await response.json();
                
                if (data.display_name) {
                    document.getElementById('orderAddress').value = data.display_name;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                document.getElementById('orderAddress').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        async function searchAddress() {
            const query = document.getElementById('addressSearch').value;
            if (!query) return;
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`
                );
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const latlng = [parseFloat(result.lat), parseFloat(result.lon)];
                    
                    // Центрируем карту
                    state.map.setView(latlng, 16);
                    
                    // Выбираем это местоположение
                    selectLocation(L.latLng(latlng));
                    
                    showToast("Адрес найден", 'success');
                } else {
                    showToast("Адрес не найден", 'danger');
                }
            } catch (error) {
                showToast("Ошибка при поиске адреса", 'danger');
            }
        }

        function searchKeyPress(e) {
            if (e.key === 'Enter') {
                searchAddress();
            }
        }

        function centerMap() {
            if (state.currentPosition) {
                state.map.setView(state.currentPosition, 14);
            } else {
                state.map.locate({setView: true, maxZoom: 14});
            }
        }

        // ===================== СОЗДАНИЕ ЗАКАЗА =====================
        function openNewOrderModal() {
            document.getElementById('newOrderModal').classList.add('active');
            
            // Очищаем форму
            document.getElementById('orderTitle').value = '';
            document.getElementById('orderDescription').value = '';
            document.getElementById('orderPrice').value = '';
            document.getElementById('orderAddress').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            state.photos = [];
            
            // Если есть выбранное место, обновляем адрес
            if (state.selectedMarker) {
                const latlng = state.selectedMarker.getLatLng();
                reverseGeocode(latlng.lat, latlng.lng);
            }
        }

        function closeNewOrderModal() {
            document.getElementById('newOrderModal').classList.remove('active');
        }

        function handlePhotoUpload() {
            const files = document.getElementById('orderPhotos').files;
            const preview = document.getElementById('photoPreview');
            
            for (let file of files) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" class="preview-img">
                        <button class="preview-remove" onclick="removePhoto(this)">×</button>
                    `;
                    
                    preview.appendChild(previewItem);
                    
                    // Сохраняем фото в состояние
                    state.photos.push({
                        file: file,
                        url: e.target.result
                    });
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(button) {
            const previewItem = button.parentElement;
            const index = Array.from(previewItem.parentElement.children).indexOf(previewItem);
            
            // Удаляем из состояния
            state.photos.splice(index, 1);
            
            // Удаляем из DOM
            previewItem.remove();
        }

        async function createOrder() {
            showLoading();
            
            if (!state.selectedLocation) {
                showToast("Выберите место на карте", 'danger');
                hideLoading();
                return;
            }
            
            const title = document.getElementById('orderTitle').value;
            const description = document.getElementById('orderDescription').value;
            const price = parseInt(document.getElementById('orderPrice').value);
            const address = document.getElementById('orderAddress').value;
            
            if (!title || !description || !price || !address) {
                showToast("Заполните все обязательные поля", 'danger');
                hideLoading();
                return;
            }
            
            if (price < 100) {
                showToast("Минимальная стоимость заказа - 100 руб.", 'danger');
                hideLoading();
                return;
            }
            
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .insert([
                        {
                            title,
                            description,
                            price,
                            address,
                            location: state.selectedLocation,
                            customer_id: state.user.id,
                            status: 'new',
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select(`
                        *,
                        customer:profiles!orders_customer_id_fkey(name, rating)
                    `)
                    .single();
                
                if (error) throw error;
                
                state.orders.unshift(order);
                updateOrdersList();
                addOrderMarker(order);
                closeNewOrderModal();
                showToast('Заказ успешно создан!', 'success');
                
            } catch (error) {
                console.error('Error creating order:', error);
                showToast('Ошибка создания заказа', 'danger');
            }
            
            hideLoading();
        }

        function addOrderMarker(order) {
            if (order.location) {
                const latlng = order.location.lat && order.location.lng 
                    ? L.latLng(order.location.lat, order.location.lng)
                    : null;
                
                if (latlng) {
                    const marker = createPulsingMarker(
                        latlng,
                        order.title,
                        'order'
                    );
                    
                    marker.on('click', () => {
                        viewOrderDetails(order.id);
                    });
                    
                    state.markers.set(order.id, marker);
                }
            }
        }

        function updateMapMarkers() {
            // Очищаем старые маркеры
            state.markers.forEach(marker => {
                state.map.removeLayer(marker);
            });
            state.markers.clear();
            
            // Добавляем новые маркеры
            state.orders.forEach(order => {
                if (order.location) {
                    const latlng = order.location.lat && order.location.lng 
                        ? L.latLng(order.location.lat, order.location.lng)
                        : null;
                    
                    if (latlng) {
                        const marker = createPulsingMarker(
                            latlng,
                            order.title,
                            'order'
                        );
                        
                        marker.on('click', () => {
                            viewOrderDetails(order.id);
                        });
                        
                        state.markers.set(order.id, marker);
                    }
                }
            });
        }

        // ===================== РАБОТА С ЗАКАЗАМИ =====================
        window.takeOrder = async function(orderId) {
            showLoading();
            
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .update({
                        status: 'active',
                        master_id: state.user.id,
                        accepted_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .eq('status', 'new')
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Заказ принят в работу!', 'success');
                loadOrders(); // Перезагружаем список заказов
                closeInfo();
                
            } catch (error) {
                console.error('Error taking order:', error);
                showToast('Ошибка принятия заказа', 'danger');
            }
            
            hideLoading();
        }

        window.completeOrder = async function(orderId) {
            showLoading();
            
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .eq('master_id', state.user.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Заказ завершен!', 'success');
                loadOrders();
                closeInfo();
                
            } catch (error) {
                console.error('Error completing order:', error);
                showToast('Ошибка завершения заказа', 'danger');
            }
            
            hideLoading();
        }

        window.viewOrderDetails = function(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            
            state.selectedOrder = order;
            
            document.getElementById('infoTitle').textContent = order.title;
            
            // Заполняем контент
            const content = document.getElementById('infoContent');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 28px; font-weight: bold; color: var(--success); margin-bottom: 10px;">
                        ${order.price} ₽
                    </div>
                    <div style="color: #64748B; margin-bottom: 5px;">
                        <i class="fas fa-map-marker-alt"></i> ${order.address || 'Адрес не указан'}
                    </div>
                    <div style="color: #64748B;">
                        <i class="fas fa-clock"></i> ${new Date(order.created_at).toLocaleString()}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">Описание:</div>
                    <div>${order.description}</div>
                </div>
                
                ${state.role === 'customer' ? `
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">Статус:</div>
                    <div class="status-badge ${order.status === 'new' ? 'status-new' : order.status === 'active' ? 'status-active' : 'status-completed'}">
                        ${order.status === 'new' ? 'Новый' : order.status === 'active' ? 'В работе' : 'Завершен'}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Настраиваем кнопки действий
            const actions = document.getElementById('infoActions');
            actions.innerHTML = '';
            
            if (state.role === 'master' && order.status === 'new') {
                actions.innerHTML = `
                    <button class="btn btn-outline" onclick="closeInfo()">Отмена</button>
                    <button class="btn btn-success" onclick="takeOrder('${order.id}')">
                        <i class="fas fa-check"></i> Взять заказ
                    </button>
                `;
            } else if (state.role === 'master' && order.status === 'active' && order.master_id === state.user.id) {
                actions.innerHTML = `
                    <button class="btn btn-outline" onclick="openChat('${order.id}')">
                        <i class="fas fa-comments"></i> Чат
                    </button>
                    <button class="btn btn-success" onclick="completeOrder('${order.id}')">
                        <i class="fas fa-check-circle"></i> Завершить
                    </button>
                `;
            } else if (state.role === 'customer' && (order.status === 'active' || order.status === 'new')) {
                actions.innerHTML = `
                    <button class="btn btn-outline" onclick="openChat('${order.id}')">
                        <i class="fas fa-comments"></i> Чат
                    </button>
                    <button class="btn btn-primary" onclick="closeInfo()">Закрыть</button>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-primary" onclick="closeInfo()" style="width: 100%;">Закрыть</button>
                `;
            }
            
            document.getElementById('mapInfo').style.display = 'block';
            
            // Центрируем карту на этом заказе
            if (order.location && order.location.lat && order.location.lng) {
                state.map.setView([order.location.lat, order.location.lng], 16);
            }
        }

        window.closeInfo = function() {
            document.getElementById('mapInfo').style.display = 'none';
            state.selectedOrder = null;
        }

        // ===================== ЧАТ =====================
        window.openChat = function(orderId) {
            state.activeChatOrderId = orderId;
            document.getElementById('chatModal').classList.add('active');
            document.getElementById('chatTitle').textContent = `Чат заказа #${orderId.substring(0, 8)}`;
            loadChatMessages(orderId);
        }

        async function loadChatMessages(orderId) {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select(`
                        *,
                        sender:profiles(name, role)
                    `)
                    .eq('order_id', orderId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                displayChatMessages(messages || []);
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function displayChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender_id === state.user.id ? 'outgoing' : 'incoming'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${message.sender?.name || 'Неизвестный'}</div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-time">${new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Прокручиваем вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        window.sendChatMessage = async function() {
            if (!state.activeChatOrderId) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([
                        {
                            order_id: state.activeChatOrderId,
                            sender_id: state.user.id,
                            message: message,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (error) throw error;
                
                input.value = '';
                loadChatMessages(state.activeChatOrderId);
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Ошибка отправки сообщения', 'danger');
            }
        }

        window.chatKeyPress = function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        }

        window.closeChat = function() {
            document.getElementById('chatModal').classList.remove('active');
            state.activeChatOrderId = null;
        }

        // ===================== REALTIME ПОДПИСКИ =====================
        function setupRealtimeSubscriptions() {
            // Отписываемся от старых подписок
            state.subscriptions.forEach(sub => sub.unsubscribe());
            state.subscriptions = [];
            
            // Подписка на новые заказы (для мастера)
            if (state.role === 'master') {
                const ordersSubscription = supabase
                    .channel('orders-channel')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'orders' },
                        async (payload) => {
                            const { data: order, error } = await supabase
                                .from('orders')
                                .select(`
                                    *,
                                    customer:profiles!orders_customer_id_fkey(name, rating)
                                `)
                                .eq('id', payload.new.id)
                                .single();
                            
                            if (!error && order && order.status === 'new') {
                                state.orders.unshift(order);
                                updateOrdersList();
                                addOrderMarker(order);
                                playNotificationSound();
                                showToast('Появился новый заказ!', 'success');
                            }
                        }
                    )
                    .subscribe();
                
                state.subscriptions.push(ordersSubscription);
            }
            
            // Подписка на обновления заказов
            const ordersUpdateSubscription = supabase
                .channel('orders-update-channel')
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'orders' },
                    async (payload) => {
                        const orderIndex = state.orders.findIndex(o => o.id === payload.new.id);
                        
                        if (orderIndex !== -1) {
                            const { data: order, error } = await supabase
                                .from('orders')
                                .select(`
                                    *,
                                    customer:profiles!orders_customer_id_fkey(name, rating),
                                    master:profiles!orders_master_id_fkey(name, rating)
                                `)
                                .eq('id', payload.new.id)
                                .single();
                            
                            if (!error && order) {
                                state.orders[orderIndex] = order;
                                updateOrdersList();
                                
                                if (payload.new.status === 'active' && 
                                    payload.new.master_id === state.user.id) {
                                    showToast('Вы приняли заказ в работу!', 'success');
                                }
                            }
                        }
                    }
                )
                .subscribe();
            
            state.subscriptions.push(ordersUpdateSubscription);
            
            // Подписка на сообщения
            const messagesSubscription = supabase
                .channel('messages-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' },
                    async (payload) => {
                        if (state.activeChatOrderId === payload.new.order_id) {
                            loadChatMessages(state.activeChatOrderId);
                            playNotificationSound();
                        }
                    }
                )
                .subscribe();
            
            state.subscriptions.push(messagesSubscription);
        }

        // ===================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====================
        window.toggleSidePanel = function() {
            const panel = document.getElementById('sidePanel');
            const icon = document.getElementById('panelToggleIcon');
            
            state.sidePanelOpen = !state.sidePanelOpen;
            panel.classList.toggle('hidden');
            
            icon.className = state.sidePanelOpen ? 
                'fas fa-chevron-left' : 'fas fa-chevron-right';
        }

        window.switchRole = function(role) {
            state.role = role;
            
            // Обновляем кнопки
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Обновляем интерфейс
            document.getElementById('userRole').textContent = 
                role === 'customer' ? 'Заказчик' : 'Мастер';
            document.getElementById('titleText').textContent = 
                role === 'customer' ? 'Мои заказы' : 'Доступные заказы';
            
            // Обновляем заказы
            loadOrders();
        }

        window.toggleTheme = function() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('microhelp_theme', state.theme);
            loadTheme();
            updateMapStyle();
        }

        function loadTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            const icon = state.theme === 'light' ? 'fa-moon' : 'fa-sun';
            document.getElementById('themeIcon').className = `fas ${icon}`;
        }

        function updateMapStyle() {
            // Обновляем слой карты при смене темы
            state.map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    state.map.removeLayer(layer);
                }
            });
            
            const newLayer = createCustomTileLayer();
            newLayer.addTo(state.map);
        }

        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play failed:", e));
            } catch (e) {
                console.log("Audio error:", e);
            }
        }

        function setupEventListeners() {
            // Анимация при загрузке
            setTimeout(() => {
                document.querySelectorAll('.order-card').forEach((card, i) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        card.offsetHeight; // Trigger reflow
                        card.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, i * 100);
                });
            }, 300);
        }

        function setupSwipeGestures() {
            // Реализация свайпов для карточек заказов
            document.querySelectorAll('.order-card').forEach(card => {
                let startX = 0;
                let currentX = 0;
                
                card.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, { passive: true });
                
                card.addEventListener('touchmove', (e) => {
                    currentX = e.touches[0].clientX - startX;
                    card.style.transform = `translateX(${currentX}px)`;
                }, { passive: true });
                
                card.addEventListener('touchend', () => {
                    if (Math.abs(currentX) > 100) {
                        const orderId = card.dataset.orderId;
                        if (currentX > 0 && state.role === 'master') {
                            // Свайп вправо - взять заказ
                            takeOrder(orderId);
                        } else if (currentX < 0) {
                            // Свайп влево - просмотреть детали
                            viewOrderDetails(orderId);
                        }
                    }
                    card.style.transform = 'translateX(0)';
                });
            });
        }

        window.logout = async function() {
            showLoading();
            
            // Отписываемся от всех подписок
            state.subscriptions.forEach(subscription => {
                subscription.unsubscribe();
            });
            state.subscriptions = [];
            
            // Выход из системы
            await supabase.auth.signOut();
            state.user = null;
            
            // Скрываем основной интерфейс
            document.getElementById('mainInterface').style.display = 'none';
            
            // Показываем экран авторизации
            showAuthModal();
            hideLoading();
            showToast('Вы вышли из системы', 'success');
        }

        // ===================== ЭКСПОРТ ОСТАЛЬНЫХ ФУНКЦИЙ =====================
        window.centerMap = centerMap;
        window.searchAddress = searchAddress;
        window.searchKeyPress = searchKeyPress;
        window.openNewOrderModal = openNewOrderModal;
        window.closeNewOrderModal = closeNewOrderModal;
        window.handlePhotoUpload = handlePhotoUpload;
        window.removePhoto = removePhoto;
        window.createOrder = createOrder;

        // Запуск при загрузке
        window.onload = function() {
            initApp();
            checkUserStatus();
        };
    </script>
</body>
</html>
