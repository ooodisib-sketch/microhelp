-- Создание таблицы profiles
CREATE TABLE IF NOT EXISTS profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  name TEXT,
  phone TEXT,
  description TEXT,
  role TEXT DEFAULT 'customer',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Создание таблицы orders с правильными колонками
CREATE TABLE IF NOT EXISTS orders (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  price INTEGER,
  address TEXT,
  lat FLOAT8,
  lng FLOAT8,
  customer_id UUID REFERENCES auth.users(id),
  master_id UUID REFERENCES auth.users(id),
  status TEXT DEFAULT 'new',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  accepted_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Создание таблицы messages
CREATE TABLE IF NOT EXISTS messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  sender_id UUID REFERENCES auth.users(id),
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Включение Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- Создание политик для profiles
CREATE POLICY "Пользователи могут читать профили" 
  ON profiles FOR SELECT 
  USING (true);

CREATE POLICY "Пользователи могут обновлять свой профиль" 
  ON profiles FOR UPDATE 
  USING (auth.uid() = id);

CREATE POLICY "Пользователи могут создавать свой профиль" 
  ON profiles FOR INSERT 
  WITH CHECK (auth.uid() = id);

-- Создание политик для orders
CREATE POLICY "Все пользователи могут видеть заказы" 
  ON orders FOR SELECT 
  USING (true);

CREATE POLICY "Пользователи могут создавать заказы" 
  ON orders FOR INSERT 
  WITH CHECK (auth.uid() = customer_id);

CREATE POLICY "Заказчики могут обновлять свои заказы" 
  ON orders FOR UPDATE 
  USING (auth.uid() = customer_id);

CREATE POLICY "Мастера могут принимать заказы" 
  ON orders FOR UPDATE 
  USING (
    auth.uid() = master_id OR 
    (status = 'new' AND EXISTS (
      SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'master'
    ))
  );

-- Создание политик для messages
CREATE POLICY "Участники заказа могут читать сообщения" 
  ON messages FOR SELECT 
  USING (
    EXISTS (
      SELECT 1 FROM orders 
      WHERE orders.id = messages.order_id 
      AND (orders.customer_id = auth.uid() OR orders.master_id = auth.uid())
    )
  );

CREATE POLICY "Участники заказа могут отправлять сообщения" 
  ON messages FOR INSERT 
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM orders 
      WHERE orders.id = messages.order_id 
      AND (orders.customer_id = auth.uid() OR orders.master_id = auth.uid())
    )
  );
