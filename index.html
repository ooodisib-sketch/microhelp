<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroHelp PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; --text: #000; --w: #fff; --grey: #E5E5EA; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* –ö–ê–†–¢–ê –ò –ü–ê–ù–ï–õ–¨ */
        #map { height: 45%; width: 100%; z-index: 1; }
        #panel { height: 55%; background: var(--w); border-radius: 24px 24px 0 0; margin-top: -20px; z-index: 10; position: relative; display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        
        /* –°–ü–ò–°–û–ö –ó–ê–î–ê–ß */
        #feed { flex: 1; overflow-y: auto; padding: 20px; }
        .card { background: var(--w); border: 1px solid #EEE; padding: 16px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card h3 { margin: 0 0 5px 0; font-size: 16px; }
        .price { float: right; color: var(--p); font-weight: 800; }
        .status { font-size:12px; color:#888; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; display: block;}
        
        /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--grey); color: black; }
        .btn:active { transform: scale(0.98); }
        
        input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus { border-color: var(--p); }

        /* –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .role-selector { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .role-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: white; cursor: pointer; }
        .role-btn.active { border: 2px solid var(--p); color: var(--p); font-weight: bold; background: #f0f7ff; }

        /* –û–í–ï–†–õ–ï–ò (–í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞) */
        .overlay { position: fixed; inset: 0; background: white; z-index: 5000; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .overlay.open { transform: translateY(0); }
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-weight: 800; font-size: 18px; background: #fff; }
        
        /* –ß–ê–¢ */
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg); display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--p); color: white; border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: white; border-bottom-left-radius: 4px; border: 1px solid #ddd; }
        #chat-input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        
        /* –ö–ù–û–ü–ö–ê –ü–†–û–§–ò–õ–Ø */
        .fab { position: fixed; top: 20px; right: 20px; width: 44px; height: 44px; background: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; z-index: 2000; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="font-size: 60px; margin-bottom: 10px;">ü§ù</div>
    <h1 style="margin: 0 0 10px 0;">MicroHelp PRO</h1>
    <p style="color:#888; margin-bottom: 30px;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</p>
    
    <div id="login-form" style="width: 100%; max-width: 320px;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn btn-p" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <p onclick="toggleReg()" style="color:var(--p); font-size:14px; margin-top:20px; cursor:pointer;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
    </div>

    <div id="reg-form" style="width: 100%; max-width: 320px; display:none;">
        <input type="text" id="r-name" placeholder="–í–∞—à–µ –ò–º—è">
        <input type="email" id="r-email" placeholder="Email">
        <input type="password" id="r-pass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)">
        
        <div class="role-selector">
            <div class="role-btn active" id="role-client" onclick="setRole('client')">–Ø –ó–∞–∫–∞–∑—á–∏–∫</div>
            <div class="role-btn" id="role-worker" onclick="setRole('worker')">–Ø –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
        </div>
        
        <button class="btn btn-p" onclick="doReg()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p onclick="toggleReg()" style="color:#888; font-size:14px; margin-top:20px; cursor:pointer;">‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É</p>
    </div>
</div>

<div class="fab" onclick="openProfile()">üë§</div>

<div id="map"></div>
<div id="panel">
    <div style="padding: 20px 20px 10px 20px;">
        <h2 style="margin:0;">–õ–µ–Ω—Ç–∞ –∑–∞–¥–∞–Ω–∏–π</h2>
        <button id="add-btn" class="btn btn-p" onclick="startAdd()" style="margin-top:15px; display:none;">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>
    <div id="feed"></div>
</div>

<div id="profile-ov" class="overlay">
    <div class="header">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å <span onclick="document.getElementById('profile-ov').classList.remove('open')" style="cursor:pointer">‚úï</span></div>
    <div style="padding:30px; text-align:center;">
        <div style="font-size:60px; margin-bottom:10px;">üë§</div>
        <h2 id="p-name" style="margin:0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div id="p-role" style="color:#888; margin-bottom:30px; font-weight:600;">...</div>
        <button class="btn btn-s" onclick="logout()" style="color:red;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
</div>

<div id="chat-ov" class="overlay">
    <div class="header">
        <span id="chat-title">–ß–∞—Ç</span> 
        <span onclick="closeChat()" style="cursor:pointer">‚úï</span>
    </div>
    <div id="chat-msgs"></div>
    <div id="chat-input-area">
        <input id="msg-txt" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
        <button onclick="sendMsg()" class="btn btn-p" style="width:auto; margin:0; padding: 0 20px;">‚û§</button>
    </div>
</div>

<div id="add-ov" class="overlay">
    <div class="header">–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ <span onclick="document.getElementById('add-ov').classList.remove('open')" style="cursor:pointer">‚úï</span></div>
    <div style="padding:20px;">
        <button class="btn btn-s" id="pick-btn" onclick="pickLocation()" style="border: 2px dashed var(--p); color: var(--p);">üìç –£–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</button>
        
        <div id="add-form" style="opacity:0.4; pointer-events:none; margin-top:25px; transition:0.3s;">
            <input id="n-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å? (–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—á–∏–Ω–∏—Ç—å –∫—Ä–∞–Ω)">
            <input id="n-price" type="number" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)">
            <button class="btn btn-p" onclick="publishTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // –í–ê–®–ò –ö–õ–Æ–ß–ò SUPABASE
    // ==========================================
    const SB_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
    const SB_KEY = 'sb_publishable_b2kTzbpSmcWVrpPUPFng7Q_enwqQd8u';
    // ==========================================

    const supabase = window.supabase.createClient(SB_URL, SB_KEY);
    
    let map;
    let user = null;
    let markers = {};
    let pickMode = false;
    let pickCoords = null;
    let activeChatId = null;
    let regRole = 'client';

    // 1. –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò –ü–†–ò –ó–ê–ü–£–°–ö–ï
    async function initApp() {
        const { data } = await supabase.auth.getSession();
        if(data.session) {
            user = data.session.user;
            await loadUserProfile(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª—å –∏ –∏–º—è
            startMainInterface();
        } else {
            // –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ (–æ–Ω –≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        }
    }

    async function loadUserProfile() {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã profiles
        const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if(data) {
            user.profile = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ–±—ä–µ–∫—Ç user
        }
    }

    function startMainInterface() {
        document.getElementById('auth-screen').style.display = 'none';
        initMap();
        loadTasks();
        
        // –í–∫–ª—é—á–∞–µ–º Realtime (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
        supabase.channel('main_channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, loadTasks)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, handleNewMessage)
            .subscribe();

        // –ï—Å–ª–∏ —ç—Ç–æ –ó–∞–∫–∞–∑—á–∏–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
        if(user.profile && user.profile.role === 'client') {
            document.getElementById('add-btn').style.display = 'block';
        }
    }

    // 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    function toggleReg() {
        const login = document.getElementById('login-form');
        const reg = document.getElementById('reg-form');
        if(login.style.display === 'none') {
            login.style.display = 'block'; reg.style.display = 'none';
        } else {
            login.style.display = 'none'; reg.style.display = 'block';
        }
    }

    function setRole(r) {
        regRole = r;
        document.getElementById('role-client').className = r === 'client' ? 'role-btn active' : 'role-btn';
        document.getElementById('role-worker').className = r === 'worker' ? 'role-btn active' : 'role-btn';
    }

    async function doReg() {
        const email = document.getElementById('r-email').value;
        const password = document.getElementById('r-pass').value;
        const name = document.getElementById('r-name').value;
        
        if(!email || !password || !name) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

        const { data, error } = await supabase.auth.signUp({ email, password });
        
        if(error) return alert("–û—à–∏–±–∫–∞: " + error.message);
        
        // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ profiles
        const { error: profileError } = await supabase.from('profiles').insert([
            { id: data.user.id, name: name, role: regRole }
        ]);

        if(profileError) {
            alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: " + profileError.message);
        } else {
            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤—Ö–æ–¥.");
            location.reload();
        }
    }

    async function doLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('pass').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
        else location.reload();
    }

    async function logout() {
        await supabase.auth.signOut();
        location.reload();
    }

    // 3. –ö–ê–†–¢–ê –ò –ó–ê–î–ê–ù–ò–Ø
    function initMap() {
        // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã (–ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∏–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è)
        map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        navigator.geolocation.getCurrentPosition(pos => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 14);
        });

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞
        map.on('click', e => {
            if(pickMode) {
                pickCoords = e.latlng;
                L.marker(pickCoords).addTo(map).bindPopup("–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ").openPopup();
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ñ–æ—Ä–º—É
                document.getElementById('add-ov').classList.add('open');
                document.getElementById('add-form').style.opacity = 1;
                document.getElementById('add-form').style.pointerEvents = 'auto';
                document.getElementById('pick-btn').innerText = "‚úÖ –¢–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞";
                document.getElementById('pick-btn').style.borderColor = "#34C759";
                document.getElementById('pick-btn').style.color = "#34C759";
                pickMode = false;
            }
        });
    }

    async function loadTasks() {
        const { data: tasks } = await supabase.from('tasks').select('*').order('created_at', {ascending: false});
        renderTasks(tasks);
    }

    function renderTasks(tasks) {
        const feed = document.getElementById('feed');
        feed.innerHTML = '';
        
        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
        Object.values(markers).forEach(m => map.removeLayer(m));
        markers = {};

        tasks.forEach(t => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∑–∞–¥–∞—á–∞ –∫–æ –º–Ω–µ
            const isMyTask = (t.client_id === user.id) || (t.worker_id === user.id);
            
            // –§–∏–ª—å—Ç—Ä: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ "–ü–æ–∏—Å–∫" –∏–ª–∏ –ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
            if (t.status === 'searching' || (t.status === 'active' && isMyTask) || (t.status === 'completed' && isMyTask)) {
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤)
                if (t.status === 'searching') {
                    const m = L.marker([t.lat, t.lon]).addTo(map).bindPopup(`<b>${t.title}</b><br>${t.price} ‚ÇΩ`);
                    markers[t.id] = m;
                }

                // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                const card = document.createElement('div');
                card.className = 'card';
                
                let statusLabel = 'üü¢ –ü–æ–∏—Å–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è';
                if(t.status === 'active') statusLabel = 'üü† –í —Ä–∞–±–æ—Ç–µ';
                if(t.status === 'completed') statusLabel = '‚ö™Ô∏è –ó–∞–≤–µ—Ä—à–µ–Ω–æ';

                let actionButtons = '';

                // –ï—Å–ª–∏ —è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏ —Å—Ç–∞—Ç—É—Å "–ü–æ–∏—Å–∫" -> –ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å"
                if (user.profile.role === 'worker' && t.status === 'searching') {
                    actionButtons = `<button class="btn btn-p" onclick="takeTask(${t.id})">‚úã –í–∑—è—Ç—å –∑–∞ ${t.price} ‚ÇΩ</button>`;
                }
                
                // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏ —è —É—á–∞—Å—Ç–Ω–∏–∫ -> –ö–Ω–æ–ø–∫–∞ "–ß–∞—Ç" –∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
                if (t.status === 'active' && isMyTask) {
                    let finishBtn = '';
                    if (user.profile.role === 'client') {
                        finishBtn = `<button class="btn btn-p" onclick="finishTask(${t.id})">‚úÖ –†–∞–±–æ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞</button>`;
                    }
                    actionButtons = `
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-s" onclick="openChat(${t.id}, '${t.title}')">üí¨ –ß–∞—Ç</button>
                            ${finishBtn}
                        </div>
                    `;
                }

                if (t.status === 'completed' && isMyTask) {
                    actionButtons = `<div style="text-align:center; color:green; margin-top:10px;">‚ú® –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>`;
                }

                card.innerHTML = `
                    <span class="status">${statusLabel}</span>
                    <div class="price">${t.price} ‚ÇΩ</div>
                    <h3>${t.title}</h3>
                    ${actionButtons}
                `;
                feed.appendChild(card);
            }
        });
    }

    // 4. –î–ï–ô–°–¢–í–ò–Ø –° –ó–ê–î–ê–ß–ê–ú–ò
    function startAdd() { document.getElementById('add-ov').classList.add('open'); }
    
    function pickLocation() {
        document.getElementById('add-ov').classList.remove('open');
        pickMode = true;
        alert("–ö–æ—Å–Ω–∏—Ç–µ—Å—å –∫–∞—Ä—Ç—ã, –≥–¥–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ");
    }

    async function publishTask() {
        const title = document.getElementById('n-title').value;
        const price = document.getElementById('n-price').value;
        
        if(!title || !price || !pickCoords) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É");

        await supabase.from('tasks').insert([{
            title: title,
            price: parseInt(price),
            lat: pickCoords.lat,
            lon: pickCoords.lng,
            client_id: user.id,
            status: 'searching'
        }]);

        document.getElementById('add-ov').classList.remove('open');
        document.getElementById('n-title').value = '';
        document.getElementById('pick-btn').innerText = "üìç –£–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ";
        document.getElementById('add-form').style.opacity = 0.4;
        document.getElementById('add-form').style.pointerEvents = 'none';
        pickCoords = null;
    }

    async function takeTask(id) {
        if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?")) {
            await supabase.from('tasks').update({ status: 'active', worker_id: user.id }).eq('id', id);
        }
    }

    async function finishTask(id) {
        if(confirm("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç—É?")) {
            await supabase.from('tasks').update({ status: 'completed' }).eq('id', id);
        }
    }

    // 5. –ß–ê–¢
    async function openChat(taskId, title) {
        activeChatId = taskId;
        document.getElementById('chat-title').innerText = title;
        document.getElementById('chat-ov').classList.add('open');
        
        const box = document.getElementById('chat-msgs');
        box.innerHTML = '<div style="text-align:center; padding:20px; color:#999">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏...</div>';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        const { data } = await supabase.from('messages').select('*').eq('task_id', taskId).order('created_at');
        box.innerHTML = '';
        data.forEach(msg => renderMessage(msg));
        box.scrollTop = box.scrollHeight;
    }

    function closeChat() {
        document.getElementById('chat-ov').classList.remove('open');
        activeChatId = null;
    }

    function handleNewMessage(payload) {
        if (payload.new.task_id === activeChatId) {
            renderMessage(payload.new);
            const box = document.getElementById('chat-msgs');
            box.scrollTop = box.scrollHeight;
        }
    }

    function renderMessage(msg) {
        const box = document.getElementById('chat-msgs');
        const div = document.createElement('div');
        const isMe = msg.sender_id === user.id;
        div.className = isMe ? 'msg me' : 'msg other';
        div.innerText = msg.text;
        box.appendChild(div);
    }

    async function sendMsg() {
        const input = document.getElementById('msg-txt');
        const text = input.value.trim();
        if(!text) return;
        
        input.value = '';
        await supabase.from('messages').insert([{
            task_id: activeChatId,
            sender_id: user.id,
            text: text
        }]);
    }

    // 6. –ü–†–û–§–ò–õ–¨
    function openProfile() {
        document.getElementById('profile-ov').classList.add('open');
        if(user && user.profile) {
            document.getElementById('p-name').innerText = user.profile.name;
            document.getElementById('p-role').innerText = user.profile.role === 'client' ? '–ó–∞–∫–∞–∑—á–∏–∫' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å';
        }
    }

    // –ó–∞–ø—É—Å–∫
    initApp();

</script>
</body>
</html>
