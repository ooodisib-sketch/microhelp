<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroHelp PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; --text: #000; --w: #fff; --grey: #E5E5EA; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #map { height: 45%; width: 100%; z-index: 1; }
        #panel { height: 55%; background: var(--w); border-radius: 24px 24px 0 0; margin-top: -20px; z-index: 10; position: relative; display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        #feed { flex: 1; overflow-y: auto; padding: 20px; }
        .card { background: var(--w); border: 1px solid #EEE; padding: 16px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card h3 { margin: 0 0 5px 0; font-size: 16px; }
        .price { float: right; color: var(--p); font-weight: 800; }
        .status { font-size:10px; color:#888; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; display: block;}
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--grey); color: black; }
        input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .role-selector { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .role-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: white; cursor: pointer; font-size: 14px; }
        .role-btn.active { border: 2px solid var(--p); color: var(--p); font-weight: bold; background: #f0f7ff; }
        .overlay { position: fixed; inset: 0; background: white; z-index: 5000; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .overlay.open { transform: translateY(0); }
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-weight: 800; font-size: 18px; background: #fff; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg); display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; }
        .msg.me { align-self: flex-end; background: var(--p); color: white; }
        .msg.other { align-self: flex-start; background: white; border: 1px solid #ddd; }
        .fab { position: fixed; top: 20px; right: 20px; width: 44px; height: 44px; background: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="font-size: 60px; margin-bottom: 10px;">ü§ù</div>
    <h1>MicroHelp PRO</h1>
    <div id="login-form" style="width: 100%; max-width: 320px;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn btn-p" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <p onclick="toggleReg()" style="color:var(--p); cursor:pointer; margin-top:20px; font-size:14px;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
    </div>
    <div id="reg-form" style="width: 100%; max-width: 320px; display:none;">
        <input type="text" id="r-name" placeholder="–í–∞—à–µ –ò–º—è">
        <input type="email" id="r-email" placeholder="Email">
        <input type="password" id="r-pass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)">
        <div class="role-selector">
            <div class="role-btn active" id="role-client" onclick="setRole('client')">–ó–∞–∫–∞–∑—á–∏–∫</div>
            <div class="role-btn" id="role-worker" onclick="setRole('worker')">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
        </div>
        <button class="btn btn-p" onclick="doReg()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p onclick="toggleReg()" style="color:#888; cursor:pointer; margin-top:20px; font-size:14px;">‚Üê –ù–∞–∑–∞–¥</p>
    </div>
</div>

<div class="fab" onclick="openProfile()">üë§</div>
<div id="map"></div>
<div id="panel">
    <div style="padding: 20px;">
        <h2 style="margin:0;">–õ–µ–Ω—Ç–∞ –∑–∞–¥–∞–Ω–∏–π</h2>
        <button id="add-btn" class="btn btn-p" onclick="startAdd()" style="display:none; margin-top:10px;">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>
    <div id="feed"></div>
</div>

<div id="profile-ov" class="overlay">
    <div class="header">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å <span onclick="closeOverlay('profile-ov')">‚úï</span></div>
    <div style="padding:30px; text-align:center;">
        <h2 id="p-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div id="p-role" style="color:#888;">–†–æ–ª—å</div>
        <button class="btn btn-s" onclick="logout()" style="color:red; margin-top:40px;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
</div>

<div id="add-ov" class="overlay">
    <div class="header">–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ <span onclick="closeOverlay('add-ov')">‚úï</span></div>
    <div style="padding:20px;">
        <button class="btn btn-s" id="pick-btn" onclick="pickLocation()">üìç –£–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</button>
        <div id="add-form" style="opacity:0.4; pointer-events:none; margin-top:20px;">
            <input id="n-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            <input id="n-price" type="number" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)">
            <button class="btn btn-p" onclick="publishTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="chat-ov" class="overlay">
    <div class="header"><span id="chat-title">–ß–∞—Ç</span> <span onclick="closeChat()">‚úï</span></div>
    <div id="chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:10px; background:white; border-top:1px solid #eee;">
        <input id="msg-txt" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
        <button onclick="sendMsg()" class="btn btn-p" style="width:auto; margin:0; padding:0 20px;">‚û§</button>
    </div>
</div>

<script>
    // 1. –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï –§–£–ù–ö–¶–ò–ô (–¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ)
    // –≠—Ç–æ —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É —Å "is not defined"
    
    window.toggleReg = function() {
        console.log("–ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞");
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('reg-form');
        if (loginForm.style.display === 'none') {
            loginForm.style.display = 'block';
            regForm.style.display = 'none';
        } else {
            loginForm.style.display = 'none';
            regForm.style.display = 'block';
        }
    };

    window.setRole = function(role) {
        regRole = role;
        document.getElementById('role-client').classList.toggle('active', role === 'client');
        document.getElementById('role-worker').classList.toggle('active', role === 'worker');
    };

    // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SUPABASE –ò –ü–ï–†–ï–ú–ï–ù–ù–´–•
    const SB_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
    const SB_KEY = 'sb_publishable_b2kTzbpSmcWVrpPUPFng7Q_enwqQd8u';
    
    let supabase;
    let map, user = null, markers = {}, pickMode = false, pickCoords = null, activeChatId = null, regRole = 'client';

    try {
        supabase = window.supabase.createClient(SB_URL, SB_KEY);
        console.log("Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    } catch (e) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Supabase:", e);
        alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
    }

    // 3. –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
    window.doLogin = async function() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        console.log("–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞:", email);
        
        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) {
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
        } else {
            location.reload();
        }
    };

    window.doReg = async function() {
        const email = document.getElementById('r-email').value;
        const pass = document.getElementById('r-pass').value;
        const name = document.getElementById('r-name').value;
        
        if (!email || !pass || !name) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

        const { data, error } = await supabase.auth.signUp({ email, password: pass });
        if (error) return alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + error.message);

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        const { error: pErr } = await supabase.from('profiles').insert([
            { id: data.user.id, name: name, role: regRole }
        ]);
        
        if (pErr) console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:", pErr);
        alert("–£—Å–ø–µ—Ö! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.");
        location.reload();
    };

    // 4. –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê (–ü—Ä–æ—Ñ–∏–ª—å, –ö–∞—Ä—Ç–∞, –ß–∞—Ç)
    window.openProfile = function() {
        document.getElementById('profile-ov').classList.add('open');
        if (user && user.profile) {
            document.getElementById('p-name').innerText = user.profile.name;
            document.getElementById('p-role').innerText = user.profile.role === 'client' ? '–ó–∞–∫–∞–∑—á–∏–∫' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å';
        }
    };

    window.logout = async () => { await supabase.auth.signOut(); location.reload(); };
    window.closeOverlay = (id) => document.getElementById(id).classList.remove('open');

    // –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ");
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
            user = session.user;
            const { data: prof } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            user.profile = prof;
            
            document.getElementById('auth-screen').style.display = 'none';
            if (prof && prof.role === 'client') document.getElementById('add-btn').style.display = 'block';
            
            initMap();
            loadTasks();
        }
    });

    function initMap() {
        if (!window.L) return console.error("Leaflet –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
        map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        map.on('click', e => {
            if (pickMode) {
                pickCoords = e.latlng;
                L.marker(e.latlng).addTo(map);
                document.getElementById('add-ov').classList.add('open');
                document.getElementById('add-form').style.opacity = 1;
                document.getElementById('add-form').style.pointerEvents = 'auto';
                pickMode = false;
            }
        });
    }

    async function loadTasks() {
        const { data: tasks } = await supabase.from('tasks').select('*').order('created_at', {ascending: false});
        const feed = document.getElementById('feed');
        feed.innerHTML = '';
        tasks?.forEach(t => {
            const isMy = (t.client_id === user.id || t.worker_id === user.id);
            if (t.status === 'searching' || isMy) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h3>${t.title}</h3><p>${t.price} ‚ÇΩ</p>`;
                feed.appendChild(card);
            }
        });
    }
</script>
</body>
</html>

