<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroHelp | –°–µ—Ä–≤–∏—Å –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; --text: #1C1C1E; --green: #34C759; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; overflow: hidden; }
        
        /* UI Elements */
        .top-nav { position: fixed; top: 20px; left: 0; right: 0; z-index: 5000; display: flex; justify-content: space-between; padding: 0 20px; pointer-events: none; }
        .circle-btn { width: 56px; height: 56px; background: white; border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(0,0,0,0.15); pointer-events: auto; font-size: 24px; cursor: pointer; border: none; }

        #map { height: 45vh; width: 100%; position: relative; z-index: 1; }
        #content { height: 55vh; background: white; border-top-left-radius: 30px; border-top-right-radius: 30px; margin-top: -30px; z-index: 100; position: relative; overflow-y: auto; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.05); }

        .card { background: #F9F9FB; border-radius: 20px; padding: 18px; margin-bottom: 12px; border: 1px solid #EEE; }
        .badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
        
        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 10px; }
        .btn-p { background: var(--p); color: white; }
        
        .overlay { position: fixed; inset: 0; background: white; z-index: 6000; transform: translateY(100%); transition: 0.3s ease; display: flex; flex-direction: column; }
        .overlay.active { transform: translateY(0); }
        .ov-header { padding: 20px; border-bottom: 1px solid #EEE; display: flex; align-items: center; gap: 15px; font-weight: 800; }

        /* –ß–ê–¢ –§–ò–ö–° */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #E5E5EA; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; position: relative; }
        .msg.me { background: var(--p); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.other { background: white; color: black; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        #toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: #1C1C1E; color: white; padding: 12px 25px; border-radius: 50px; z-index: 9999; display: none; font-size: 14px; }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="auth" style="position:fixed; inset:0; background:white; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center;">
    <h1 style="font-size: 32px; font-weight: 800; color: var(--p);">MicroHelp</h1>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</p>
    <button class="btn btn-p" onclick="start('client')">–Ø –ó–∞–∫–∞–∑—á–∏–∫</button>
    <button class="btn btn-p" onclick="start('worker')" style="background:#1C1C1E; margin-top:10px;">–Ø –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</button>
</div>

<div class="top-nav" id="ui" style="display:none">
    <button class="circle-btn" onclick="openCreate()" id="add-btn">‚ûï</button>
    <button class="circle-btn" onclick="openOverlay('profile')">üë§</button>
</div>

<div id="map"></div>
<div id="content">
    <h3 id="feed-title">–ó–∞–¥–∞–Ω–∏—è —Ä—è–¥–æ–º</h3>
    <div id="feed"></div>
</div>

<div id="ov-create" class="overlay">
    <div class="ov-header"><button onclick="closeOv()" style="border:none; background:none; font-size:24px;">‚úï</button> –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</div>
    <div style="padding:20px;">
        <input id="c-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" style="width:100%; padding:15px; border-radius:12px; border:1px solid #DDD; margin-bottom:10px;">
        <textarea id="c-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." style="width:100%; padding:15px; border-radius:12px; border:1px solid #DDD; margin-bottom:10px;"></textarea>
        <input id="c-price" type="number" placeholder="–ë—é–¥–∂–µ—Ç –≤ ‚ÇΩ" style="width:100%; padding:15px; border-radius:12px; border:1px solid #DDD; margin-bottom:10px;">
        <p style="font-size:12px; color:var(--p)">* –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏</p>
        <button class="btn btn-p" onclick="saveTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
</div>

<div id="ov-chat" class="overlay">
    <div class="ov-header"><button onclick="closeOv()" style="border:none; background:none; font-size:24px;">‚úï</button> –ß–∞—Ç —Å –º–∞—Å—Ç–µ—Ä–æ–º</div>
    <div id="chat-box"></div>
    <div style="padding:15px; display:flex; gap:10px; border-top:1px solid #EEE;">
        <input id="chat-inp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; padding:12px; border-radius:20px; border:1px solid #DDD;">
        <button class="circle-btn" onclick="sendMsg()" style="width:45px; height:45px; box-shadow:none; background:var(--p); color:white;">‚û§</button>
    </div>
</div>

<script>
    const SB_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
    const SB_KEY = 'sb_publishable_b2kTzbpSmcWVrpPUPFng7Q_enwqQd8u';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let user = { id: localStorage.getItem('uid') || 'u'+Date.now(), role: '', lat: 55.75, lon: 37.61 };
    localStorage.setItem('uid', user.id);

    let map, markers = {}, activeChat = null;
    const STATUS_RU = { 'searching': '–ü–æ–∏—Å–∫', 'active': '–í —Ä–∞–±–æ—Ç–µ', 'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' };

    async function start(role) {
        user.role = role;
        document.getElementById('auth').style.display = 'none';
        document.getElementById('ui').style.display = 'flex';
        if(role === 'worker') document.getElementById('add-btn').style.display = 'none';
        
        initMap();
        load();
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        _supabase.channel('any').on('postgres_changes', {event:'*', schema:'public', table:'tasks'}, load).subscribe();
        _supabase.channel('msgs').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, (p) => {
            if(p.new.task_id === activeChat) appendMsg(p.new);
        }).subscribe();
    }

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([user.lat, user.lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        navigator.geolocation.getCurrentPosition(p => {
            user.lat = p.coords.latitude; user.lon = p.coords.longitude;
            map.setView([user.lat, user.lon], 14);
            L.circleMarker([user.lat, user.lon], { radius: 7, color: '#007AFF' }).addTo(map);
        });
    }

    async function load() {
        const { data: tasks } = await _supabase.from('tasks').select('*').order('created_at', {ascending: false});
        render(tasks);
    }

    function render(tasks) {
        const feed = document.getElementById('feed');
        feed.innerHTML = '';
        Object.values(markers).forEach(m => map.removeLayer(m));

        tasks.forEach(t => {
            // –°—Ç–∞—Ç—É—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º
            const sRu = STATUS_RU[t.status] || t.status;
            const isMy = t.client_id === user.id || t.worker_id === user.id;

            // –ö–∞—Ä—Ç–æ—á–∫–∏
            if(t.status === 'searching' || isMy) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <span class="badge" style="background:${t.status==='active'?'#FFF4E5':'#EBF5FF'}; color:${t.status==='active'?'#FF9500':'#007AFF'}">${sRu}</span>
                    <div style="display:flex; justify-content:space-between;">
                        <b>${t.title}</b>
                        <span>${t.price} ‚ÇΩ</span>
                    </div>
                    <p style="font-size:13px; opacity:0.6; margin:10px 0;">${t.description || ''}</p>
                `;

                if(t.status === 'searching' && user.role === 'worker') {
                    const b = document.createElement('button'); b.className='btn btn-p'; b.innerText='–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É';
                    b.onclick = () => take(t.id); card.appendChild(b);
                }
                if(t.status === 'active' && isMy) {
                    const b = document.createElement('button'); b.className='btn btn-p'; b.innerText='–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç';
                    b.style.background = '#1C1C1E';
                    b.onclick = () => openChat(t.id); card.appendChild(b);
                }
                feed.appendChild(card);
            }

            // –ú–∞—Ä–∫–µ—Ä—ã
            if(t.status === 'searching') {
                markers[t.id] = L.marker([t.lat, t.lon]).addTo(map).bindPopup(t.title);
            }
        });
    }

    async function take(id) {
        await _supabase.from('tasks').update({ status: 'active', worker_id: user.id }).eq('id', id);
        toast("–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑!");
    }

    async function saveTask() {
        const title = document.getElementById('c-title').value;
        const price = document.getElementById('c-price').value;
        if(!title || !price) return toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

        await _supabase.from('tasks').insert([{
            title, 
            description: document.getElementById('c-desc').value,
            price: parseInt(price),
            client_id: user.id,
            lat: user.lat,
            lon: user.lon,
            status: 'searching'
        }]);
        
        closeOv();
        toast("–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!");
    }

    // –ß–ê–¢ –§–£–ù–ö–¶–ò–ò
    async function openChat(tid) {
        activeChat = tid;
        document.getElementById('chat-box').innerHTML = '';
        openOverlay('ov-chat');
        const { data } = await _supabase.from('messages').select('*').eq('task_id', tid).order('created_at');
        if(data) data.forEach(appendMsg);
    }

    function appendMsg(m) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${m.sender_id === user.id ? 'me' : 'other'}`;
        div.innerText = m.text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const inp = document.getElementById('chat-inp');
        if(!inp.value || !activeChat) return;
        const text = inp.value; inp.value = '';
        await _supabase.from('messages').insert([{ task_id: activeChat, sender_id: user.id, text }]);
    }

    function openCreate() { openOverlay('ov-create'); }
    function openOverlay(id) { document.getElementById(id === 'profile' ? 'ov-create' : id).classList.add('active'); } 
    function closeOv() { document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active')); activeChat = null; }
    function toast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
</script>
</body>
</html>
