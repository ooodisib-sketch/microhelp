<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroHelp PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; --text: #000; --w: #fff; --grey: #E5E5EA; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #map { height: 45%; width: 100%; z-index: 1; }
        #panel { height: 55%; background: var(--w); border-radius: 24px 24px 0 0; margin-top: -20px; z-index: 10; position: relative; display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        #feed { flex: 1; overflow-y: auto; padding: 20px; }
        .card { background: var(--w); border: 1px solid #EEE; padding: 16px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card h3 { margin: 0 0 5px 0; font-size: 16px; }
        .price { float: right; color: var(--p); font-weight: 800; }
        .status { font-size:12px; color:#888; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; display: block;}
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--grey); color: black; }
        input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .role-selector { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .role-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: white; cursor: pointer; }
        .role-btn.active { border: 2px solid var(--p); color: var(--p); font-weight: bold; background: #f0f7ff; }
        .overlay { position: fixed; inset: 0; background: white; z-index: 5000; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .overlay.open { transform: translateY(0); }
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-weight: 800; font-size: 18px; background: #fff; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg); display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; }
        .msg.me { align-self: flex-end; background: var(--p); color: white; }
        .msg.other { align-self: flex-start; background: white; border: 1px solid #ddd; }
        .fab { position: fixed; top: 20px; right: 20px; width: 44px; height: 44px; background: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="font-size: 60px; margin-bottom: 10px;">ü§ù</div>
    <h1>MicroHelp PRO</h1>
    <div id="login-form" style="width: 100%; max-width: 320px;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn btn-p" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <p onclick="toggleReg()" style="color:var(--p); cursor:pointer; margin-top:20px;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
    </div>
    <div id="reg-form" style="width: 100%; max-width: 320px; display:none;">
        <input type="text" id="r-name" placeholder="–í–∞—à–µ –ò–º—è">
        <input type="email" id="r-email" placeholder="Email">
        <input type="password" id="r-pass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)">
        <div class="role-selector">
            <div class="role-btn active" id="role-client" onclick="setRole('client')">–Ø –ó–∞–∫–∞–∑—á–∏–∫</div>
            <div class="role-btn" id="role-worker" onclick="setRole('worker')">–Ø –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
        </div>
        <button class="btn btn-p" onclick="doReg()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p onclick="toggleReg()" style="color:#888; cursor:pointer; margin-top:20px;">–ù–∞–∑–∞–¥</p>
    </div>
</div>

<div class="fab" onclick="openProfile()">üë§</div>
<div id="map"></div>
<div id="panel">
    <div style="padding: 20px;">
        <h2 style="margin:0;">–õ–µ–Ω—Ç–∞ –∑–∞–¥–∞–Ω–∏–π</h2>
        <button id="add-btn" class="btn btn-p" onclick="startAdd()" style="display:none; margin-top:10px;">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>
    <div id="feed"></div>
</div>

<div id="profile-ov" class="overlay">
    <div class="header">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å <span onclick="closeOverlay('profile-ov')">‚úï</span></div>
    <div style="padding:30px; text-align:center;">
        <h2 id="p-name">–ò–º—è</h2>
        <div id="p-role" style="color:#888;">–†–æ–ª—å</div>
        <button class="btn btn-s" onclick="logout()" style="color:red; margin-top:40px;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
</div>

<div id="add-ov" class="overlay">
    <div class="header">–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ <span onclick="closeOverlay('add-ov')">‚úï</span></div>
    <div style="padding:20px;">
        <button class="btn btn-s" id="pick-btn" onclick="pickLocation()">üìç –£–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</button>
        <div id="add-form" style="opacity:0.4; pointer-events:none; margin-top:20px;">
            <input id="n-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            <input id="n-price" type="number" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)">
            <button class="btn btn-p" onclick="publishTask()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="chat-ov" class="overlay">
    <div class="header"><span id="chat-title">–ß–∞—Ç</span> <span onclick="closeChat()">‚úï</span></div>
    <div id="chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:10px; background:white; border-top:1px solid #eee;">
        <input id="msg-txt" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
        <button onclick="sendMsg()" class="btn btn-p" style="width:auto; margin:0; padding:0 20px;">‚û§</button>
    </div>
</div>

<script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    const SB_URL = 'https://mrhovmabyawbfzcxwmib.supabase.co';
    const SB_KEY = 'sb_publishable_b2kTzbpSmcWVrpPUPFng7Q_enwqQd8u';
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);

    let map, user = null, markers = {}, pickMode = false, pickCoords = null, activeChatId = null, regRole = 'client';

    // --- –§—É–Ω–∫—Ü–∏–∏ (–û–±—ä—è–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ function, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫ ReferenceError) ---

    function toggleReg() {
        const login = document.getElementById('login-form');
        const reg = document.getElementById('reg-form');
        login.style.display = (login.style.display === 'none') ? 'block' : 'none';
        reg.style.display = (reg.style.display === 'none') ? 'block' : 'none';
    }

    function setRole(role) {
        regRole = role;
        document.getElementById('role-client').classList.toggle('active', role === 'client');
        document.getElementById('role-worker').classList.toggle('active', role === 'worker');
    }

    async function doReg() {
        const email = document.getElementById('r-email').value;
        const pass = document.getElementById('r-pass').value;
        const name = document.getElementById('r-name').value;
        if(!email || !pass || !name) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è");

        const { data, error } = await supabase.auth.signUp({ email, password: pass });
        if(error) return alert("–û—à–∏–±–∫–∞: " + error.message);

        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –ë–î
        await supabase.from('profiles').insert([{ id: data.user.id, name, role: regRole }]);
        alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
        location.reload();
    }

    async function doLogin() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(error) alert("–û—à–∏–±–∫–∞: " + error.message);
        else location.reload();
    }

    async function logout() {
        await supabase.auth.signOut();
        location.reload();
    }

    function startAdd() { document.getElementById('add-ov').classList.add('open'); }
    function closeOverlay(id) { document.getElementById(id).classList.remove('open'); }

    function pickLocation() {
        closeOverlay('add-ov');
        pickMode = true;
        alert("–ö–æ—Å–Ω–∏—Å—å –∫–∞—Ä—Ç—ã –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ");
    }

    async function publishTask() {
        const title = document.getElementById('n-title').value;
        const price = document.getElementById('n-price').value;
        if(!title || !price || !pickCoords) return alert("–ó–∞–ø–æ–ª–Ω–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É");
        
        await supabase.from('tasks').insert([{
            title, price, lat: pickCoords.lat, lon: pickCoords.lng, 
            client_id: user.id, status: 'searching'
        }]);
        location.reload();
    }

    async function takeTask(taskId) {
        if(confirm("–ë–µ—Ä–µ—Ç–µ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?")) {
            await supabase.from('tasks').update({ status: 'active', worker_id: user.id }).eq('id', taskId);
            location.reload();
        }
    }

    async function finishTask(taskId) {
        if(confirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ?")) {
            await supabase.from('tasks').update({ status: 'completed' }).eq('id', taskId);
            location.reload();
        }
    }

    async function openChat(taskId, title) {
        activeChatId = taskId;
        document.getElementById('chat-title').innerText = title;
        document.getElementById('chat-ov').classList.add('open');
        loadMessages(taskId);
    }

    function closeChat() { closeOverlay('chat-ov'); activeChatId = null; }

    async function loadMessages(taskId) {
        const { data } = await supabase.from('messages').select('*').eq('task_id', taskId).order('created_at');
        const box = document.getElementById('chat-msgs');
        box.innerHTML = '';
        data?.forEach(msg => {
            const div = document.createElement('div');
            div.className = msg.sender_id === user.id ? 'msg me' : 'msg other';
            div.innerText = msg.text;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const input = document.getElementById('msg-txt');
        const text = input.value.trim();
        if(!text) return;
        await supabase.from('messages').insert([{ task_id: activeChatId, sender_id: user.id, text }]);
        input.value = '';
        loadMessages(activeChatId);
    }

    function openProfile() {
        document.getElementById('profile-ov').classList.add('open');
        if(user?.profile) {
            document.getElementById('p-name').innerText = user.profile.name;
            document.getElementById('p-role').innerText = user.profile.role === 'client' ? '–ó–∞–∫–∞–∑—á–∏–∫' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å';
        }
    }

    // --- –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if(session) {
            user = session.user;
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            user.profile = profile;
            
            document.getElementById('auth-screen').style.display = 'none';
            if(profile.role === 'client') document.getElementById('add-btn').style.display = 'block';

            initMap();
            loadTasks();
        }
    }

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', e => {
            if(pickMode) {
                pickCoords = e.latlng;
                L.marker(e.latlng).addTo(map).bindPopup("–ú–µ—Å—Ç–æ –∑–∞–¥–∞–Ω–∏—è").openPopup();
                document.getElementById('add-ov').classList.add('open');
                document.getElementById('add-form').style.opacity = 1;
                document.getElementById('add-form').style.pointerEvents = 'auto';
                document.getElementById('pick-btn').innerText = "‚úÖ –ú–µ—Å—Ç–æ –≤—ã–±—Ä–∞–Ω–æ";
                pickMode = false;
            }
        });
    }

    async function loadTasks() {
        const { data: tasks } = await supabase.from('tasks').select('*').order('created_at', {ascending: false});
        const feed = document.getElementById('feed');
        feed.innerHTML = '';

        tasks?.forEach(t => {
            const isMy = (t.client_id === user.id || t.worker_id === user.id);
            if(t.status === 'searching' || isMy) {
                if(t.status === 'searching') L.marker([t.lat, t.lon]).addTo(map).bindPopup(t.title);
                
                const card = document.createElement('div');
                card.className = 'card';
                let btns = '';
                
                if(user.profile.role === 'worker' && t.status === 'searching') {
                    btns = `<button class="btn btn-p" onclick="takeTask(${t.id})">–í–∑—è—Ç—å –∑–∞ ${t.price}‚ÇΩ</button>`;
                } else if(isMy && t.status === 'active') {
                    btns = `<div style="display:flex;gap:10px;">
                        <button class="btn btn-s" onclick="openChat(${t.id},'${t.title}')">üí¨ –ß–∞—Ç</button>
                        ${user.profile.role === 'client' ? `<button class="btn btn-p" onclick="finishTask(${t.id})">–ü—Ä–∏–Ω—è—Ç—å</button>` : ''}
                    </div>`;
                }
                
                card.innerHTML = `<span class="status">${t.status}</span><div class="price">${t.price}‚ÇΩ</div><h3>${t.title}</h3>${btns}`;
                feed.appendChild(card);
            }
        });
    }

    init();
</script>
</body>
</html>
